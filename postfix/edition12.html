<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html>
<head>
	<title>How to set up a mail server on a GNU / Linux system</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
	<link href="edition4/postfix.css" rel="stylesheet" type="text/css" />
	<link href="edition8/postfix.css" rel="stylesheet" type="text/css" />
	<link href="edition9/postfix.css" rel="stylesheet" type="text/css" />
	<link href="edition10/postfix.css" rel="stylesheet" type="text/css" />
	<style>
	</style>
</head>
<body>
<a name="top"></a>
<a href="http://creativecommons.org/licenses/by-sa/2.5/"><img
	src="/images/cc-by-sa-small.png" alt="cc by-sa" height="25" class="fright"
	title="Creative Commons Attributions-ShareAlike" border="0" align="right"/></a>
<a href="http://flurdy.com"><img class="fright"
	src="/images/flurdy-small.png" alt="flurdy" height="23"
	title="Made by flurdy" border="0" align="right" /></a>
<h1>How to set up a mail server on a GNU / Linux system</h1>
<a name=""></a><h3>Step by step guide to install Postfix</h3>
<h3>
		Ubuntu + Postfix + Courier IMAP + MySQL
		+ Amavisd-new + SpamAssassin + ClamAV
		+ SASL + TLS + Roundcube + Postgrey
</h3>
	<p>
		Easy to follow howto on setting up a mail server
		with unlimited users and domains,
		with IMAP/Pop access, anti-spam, anti-virus,
		secure authentication, encrypted traffic,
		web mail interface and more.
	</p>
	<p>
		Based on an Ubuntu distribution platform,
		but instructions are distro generic.
		Examples are run on Amazon AWS ec2, but only for demonstration purposes.
	</p>

<a href="http://www.postfix.org"><img
		src="http://www.postfix.org/mysza.gif"
		alt="postfix" align="right" border="0"
		title="Postfix, the MTA." class=""	/></a>
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style">
<a class="addthis_button_email"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_delicious"></a>
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<span class="addthis_separator">|</span>
<a href="http://www.addthis.com/bookmark.php?v=250&amp;username=flurdy" class="addthis_button_expanded">More</a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#username=flurdy"></script>
<!-- AddThis Button END -->
<h6><a href="#editions">12th edition</a></h6>
<h6>
	Author <a href="#author">Ivar Abrahamsen</a>
</h6>
<h6>
	License:
	<a href="http://flurdy.com/docs/license/respect">Respect</a> (CC by-sa)
<!-- 	on top of <a href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons by-sa</a>. -->
</h6>
<h6>Last Update: 2014-08-02</h6>
<h6>
	<a href="#contact">Contact</a> /
	<a href="http://www.ubuntuforums.org/showthread.php?t=185913">Discuss</a> /
	<a href="#contribute">Contribute</a>
</h6>

<!-- <div class="section">
	<h2>Draft</h2>
	<p>
		Please use the <a href="edition7.html">last released edition</a>(7) of this howto guide.<br/>
		This edition is still currently being written, and may contain some errors still.
	</p>
</div> -->

<h2>Contents</h2>
<div class="section">
<script type="text/javascript"><!--
google_ad_client = "pub-7805345644641760";
/* top leaderboard */
google_ad_slot = "6513264856";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>
	<ul>
		<li>
			<h5><a href="#editions">Editions</a></h5>
			<p>List of different versions of this document.</p>
		</li>
		<li>
			<h5><a href="#intro">Introduction</a></h5>
			<p>Brief description of this document.</p>
			<ul>
				<li><p><a href="#intro_aim">Aim</a></p></li>
				<li><p><a href="#intro_research">Research</a></p></li>
				<li><p><a href="#intro_ego">Donate</a></p></li>
			</ul>
		</li>
		<li>
			<h5><a href="#software">Software</a></h5>
			<p>Which software packages are we using and why.</p>
		</li>
		<li>
			<h5><a href="#install">Installation</a></h5>
			<p>How to install all packages and which ones.</p>
			<ul>
				<li><p><a href="#install_distro">Distrobution</a></p></li>
				<li><p><a href="#install_base">Base Install</a></p></li>
				<li><p><a href="#install_repos">Repositories</a></p></li>
				<li><p><a href="#install_pack">Packages</a></p></li>
			</ul>
		</li>
		<li>
			<h5><a href="#config">Configuration</a></h5>
			<p>
				Post install, what to configure for each section,
				with full command examples.
			</p>
			<ul>
				<li><p><a href="#config-simple-firewall">Firewall (Shorewall)</a></p></li>
				<li><p><a href="#config-simple-database">Database (MySQL)</a></p></li>
				<li><p><a href="#config-simple-mta">MTA (Postfix)</a></p></li>
				<li><p><a href="#config-simple-imap">Pop/IMAP (Courier)</a></p></li>
				<li><p><a href="#config-adv-content">Content Checks (amivisd-new)</a></p>
					<ul>
						<li><p><a href="#config-adv-spam">Anti-Spam(SpamAssassin)</a></p></li>
						<li><p><a href="#config-adv-virus">Anti-Virus (ClamAV)</a></p></li>
						<li><p><a href="#config-adv-policy">Policy Check (PostGrey)</a></p></li>
					</ul>
				</li>
				<li><p><a href="#config-secure-auth">Authentication (SASL)</a></p></li>
				<li><p><a href="#config-secure-crypt">Encryption (TLS)</a></p></li>
				<li><p><a href="#config-extra-webmail">Webmail (Roundcube)</a></p></li>
				<li><p><a href="#config-extra-admin">Administration (phpMyAdmin)</a></p></li>
				<li><p><a href="#config-external-domain">Domain name</a></p></li>
				<li><p><a href="#config-external-dns">DNS</a></p></li>
			</ul>
		</li>
			</ul>
		</li>
		<li>
			<h5><a href="#data">Data</a></h5>
			<p>
				Creating the basic stub of data,
				and how to add your own.
			</p>
			<ul>
				<li><p><a href="#data_add">Add users and domains</a></p></li>
				<li><p><a href="#data_common">Common SQL</a></p></li>
			</ul>
		</li>
		<li>
			<h5><a href="#test">Test</a></h5>
			<p>Testing and troubleshooting each element.</p>
			<ul>
				<li><p><a href="#test-common">Common problems</a></p></li>
				<li><p><a href="#test-strategy">Test strategy</a></p></li>
				<li><p><a href="#test-debug">Switch debug on</a></p></li>
				<li><p><a href="#test-tail">Tail, tail and tail again</a></p></li>
				<li><p><a href="#test-telnet">Telnet is your friend</a></p></li>
				<li><p><a href="#test-postfix-receive">Can postfix receive?</a></p></li>
				<li><p><a href="#test-postfix-send">Can postfix send?</a></p></li>
				<li><p><a href="#test-courier">Can courier read?</a></p></li>
			</ul>
		</li>
		<li>
			<h5><a href="#initialize">Initialize</a></h5>
			<p>
				If receiving an already setup machine,
				a list of actions to do to initialize and configure it.
			</p>
		</li>
		<li>
			<h5><a href="#extend">Extend</a></h5>
			<p>
				Post working system,
				detailed instructions on optional features to add.
			</p>
			<ul>
					<li>
						<p><a href="#ext_mx">Remote MX mail backup</a></p>
						<ul>
							<li><p><a href="#ext_mx_recipient">Relay recipient lookup</a><p></li>
						</ul>
					</li>
					<li><p><a href="#ext_back">Local file backup</a></p></li>
					<li><p><a href="#ext_spf">Sender ID &amp; SPF</a></p></li>
					<li><p><a href="#ext_pyzor">Spam Reporting</a></p></li>
					<li><p><a href="#ext_list">White/Black lists</a></p></li>
					<li><p><a href="#ext_pgp">PGP &amp; S/MIME</a></p></li>
					<li><p><a href="#ext_reloc">Relocation notice</a></p></li>
					<li><p><a href="#ext_pop">Pop-before-SMTP</a></p></li>
					<li><p><a href="#ext_reply">Auto Reply</a></p></li>
					<li><p><a href="#ext_block">Block Addresses</a></p></li>
					<li><p><a href="#ext_throttle">Throttle Output</a></p></li>
					<li><p><a href="#ext_mlist">Mail Lists</a></p></li>
					<li><p><a href="#ext_admin">Admin software</a></p></li>
					<li><p><a href="#ext_gmail">Google Apps / GMail</a></p></li>
					<li><p><a href="#ext_maildrop">Maildrop, spam folder and vacation messaging</a></p></li>
					<li><p><a href="#ext_squirrel">SquirrelMail webmail client</a></p></li>
					<li><p><a href="#ext_brute">Brute Force</a><p>
						<ul>
							<li><p><a href="#ext_brute_deny">DenyHosts</a></p></li>
							<li><p><a href="#ext_brute_fail">fail2ban</a></p></li>
						</ul>
					</li>
			</ul>
		</li>
		<li>
			<h5><a href="#ec2">Elastic Compute Cloud (ec2)</a></h5>
			<p>
				Amazons' hosting service. Used as examples for this howto.
			</p>
			<ul>
				<li><p><a href="#ec2">Impressions of EC2</a></p></li>
				<li><p><a href="#ec2_tips">ec2 introduction, tips and hwotos</a></p></li>
				<li><p><a href="#ec2_use">Using EC2 with this howto</a></p></li>
				<!-- <li><p><a href="#ec2_ami">Amazon EC2 Images: AMIs</a></p></li> -->
				<li><p><a href="#ec2_links">EC2 Links</a></p></li>
			</ul>
		</li>
		<li>
			<h5><a href="#app">Appendix</a></h5>
			<ul>
				<li><p><a href="#author">About author</a></p></li>
				<li><p><a href="#contact">Contact</a></p></li>
				<li><p><a href="#contribute">Contribute</a></p></li>
				<li><p><a href="#app_why">Why</a></p></li>
				<li><p><a href="#references">References</a></p></li>
				<li><p><a href="#app_links">Software Links</a></p></li>
				<li><p><a href="#app_dif">Difference between Ubuntu versions</a></p></li>
				<li><p><a href="#download">Download</a></p></li>
				<li><p><a href="#app_todo">Todo</a></p></li>
				<li><p><a href="#app_log">Change Log</a></p></li>
				<li><p><a href="#app_faq">FAQ</a></p></li>
	</ul>
			</ul>
		</li>
	</ul>

<form action="http://www.google.com/cse" id="cse-search-box">
<div>
<input type="hidden" name="cx" value="partner-pub-7805345644641760:6bthjatxhdh" />
<input type="hidden" name="ie" value="ISO-8859-1" />
<input type="text" name="q" size="45" />
<input type="submit" name="sa" value="Search" />
</div>
</form>
<script type="text/javascript" src="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
</div>
<h6><a href="#top">Return to top</a>.</h6>


<a name="editions"></a>
<h2>Editions</h2>

<div class="section">

	<table border="1" class="editions" cellpadding="5" cellspacing="0">
		<tr>
			<th colspan="1">Edition</th>
			<th colspan="1">State</th>
			<th colspan="1">Started</th>
			<th colspan="1">Updated</th>
			<th colspan="1">Description</th>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition1.html">1st</a></td>
			<td colspan="1" nowrap>Released (outdated)</td>
			<td colspan="1" nowrap>2004-01</td>
			<td colspan="1" nowrap>2004-02</td>
			<td colspan="1" class="desc">
				Based on Mandrake 9.1.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition2.html">2nd</a></td>
			<td colspan="1" nowrap>Released (outdated)</td>
			<td colspan="1" nowrap>2004-02</td>
			<td colspan="1" nowrap>2004-07</td>
			<td colspan="1" class="desc">
				Based on Mandrake 10.x, but valid for all distributions.
				Very thorough. Includes package description, where to get the sources and binaries,
				how to build them or which RPMs to use, includes many refrences, etc etc.
				Starts off with a basic working server, then advances, extends and tightens it in stages.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition3.html">3rd</a> </td>
			<td colspan="1" nowrap>Released (outdated)</td>
			<td colspan="1" nowrap>2005-05</td>
			<td colspan="1" nowrap>2005-11</td>
			<td colspan="1" class="desc">
				Based on Ubuntu 5.04, Hoary Hedgehog.
				More concise simplified guide to get an advanced server working quickly.
				Now includes SASL &amp; TLS integration.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition4.html">4th</a></td>
			<td colspan="1" nowrap>Released (outdated)</td>
			<td colspan="1" nowrap>2005-10</td>
			<td colspan="1" nowrap>2005-12</td>
			<td colspan="1" class="desc">
				Based on Breezy Badger, Ubuntu 5.10.
				Includes Postgrey
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition5.html">5th</a></td>
			<td colspan="1">
				Released (outdated)
			</td>
			<td colspan="1" nowrap>2006-05</td>
			<td colspan="1" nowrap>2006-11</td>
			<td colspan="1" class="desc">
				Based on Dapper Drake, Ubuntu 6.06 LTS.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><strike>6th</strike></td>
			<td colspan="1">
				Scrapped
			</td>
			<td colspan="1" nowrap>2006-11</td>
			<td colspan="1" nowrap>2007-10</td>
			<td colspan="1" class="desc">
				Was to be based on Edgy Eft, Ubuntu 6.10 or 7.04.
				include Domain Key signing.
				include my mail admin or my catchall aliases admin.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition7.html">7th</a></td>
			<td colspan="1">
				Released (outdated)
			</td>
			<td colspan="1" nowrap>2008-04</td>
			<td colspan="1" nowrap>2009-06</td>
			<td colspan="1" class="desc">
				Updated, based on Ubuntu 8.04 LTS Hardy Heron.
				Using Amazon EC2 as example.
				(Tested with 8.10 & 9.04 as well)
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition8.html">8th</a></td>
			<td colspan="1">
				Released (superseeded)
			</td>
			<td colspan="1" nowrap>2009-05</td>
			<td colspan="1" nowrap>2009-11</td>
			<td colspan="1" class="desc">
				Based on Ubuntu 8.10 (intrepid),
				then tested with 9.04 (jaunty) &amp; 9.10 (karmic) as well.
				Using official Ubuntu ec2 as examples.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition9.html">9th</a></td>
			<td colspan="1">
				Released (superseeded)
			</td>
			<td colspan="1" nowrap>2009-11</td>
			<td colspan="1" nowrap>2010-05</td>
			<td colspan="1" class="desc">
				Based on Ubuntu 9.10 (karmic) using Canonical's cloud images.
				Added Roundcube webmail option.
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition10.html">10th</a></td>
			<td colspan="1">
			Released
			</td>
			<td colspan="1" nowrap>2009-12</td>
			<td colspan="1" nowrap>2013-01</td>
			<td colspan="1" class="desc">
				Based on Ubuntu 10.04 LTS (lucid) using Canonical's cloud images.
				Tested on 10.10 (maverick).
				Tested on 11.04 (natty)
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap><a href="edition11.html">11th</a></td>
			<td colspan="1">
				Released
			</td>
			<td colspan="1" nowrap>2012-11</td>
			<td colspan="1" nowrap>2014-05</td>
			<td colspan="1" class="desc">
				Based on Ubuntu 12.04 (precise). Tested with 12.10 (quantal) and 13.04 (raring)
			</td>
		</tr>
		<tr>
			<td colspan="1" nowrap>12th (this)</td>
			<td colspan="1">
				Released
			</td>
			<td colspan="1" nowrap>2014-05</td>
			<td colspan="1" nowrap>2014-08</td>
			<td colspan="1" class="desc">
				Based on Ubuntu 14.04 (trusty).
			</td>
		</tr>
	</table>

	<h5>
		Further details available in the <a href="#app_log">change log</a> and below in the <a href="#intro">introduction</a>.
	</h5>

</div>
<h6><a href="#top">Return to top</a>.</h6>

<!--
<a name="dev"></a>
<h2>Notice</h2>

<div class="section">
	<p>
		<b>Disclaimer</b>.
	</p>
	<p>
		This edition is still in draft mode, so some sections are still to be thoroughly retested.
	</p>
	<
	<p>
		You may prefer to use the <a href="edition11.html">previous howto edition</a>(11th),
		whilst we iron out any errors and missing sections.
	</p>
	-

	<p>
		If you find any spelling mistakes or broken links, <a href="#contact">please let me know</a>.
		Any clear technical mistakes, then  <a href="#contact">let me know</a>.
		But if technical difference of opinion, <a href="#forum">please use the forum</a>.
		Any questions / problems <a href="#forum">please use the forum</a>.
	</p>
</div>
<h6><a href="#top">Return to top</a>.</h6>
-->


<a name="intro"></a>
<h2>Introduction</h2>

<div class="section">

	<a name="intro_aim"></a>
	<h3>Aim</h3>
	<p>
		This is a step by step howto guide to set
		up a mail server on a GNU / Linux system.
		It is easy to follow, but you
		end up with a powerfull secure mail server.
	</p>
	<p>
		The server accepts unlimited domains and users,
		and all mail can be read via your favourite clients,
		or via web mail.
	</p>
	<p>
		It is secure, traffic can encrypted
		and it will block virtually all spam and viruses.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>

	<a name="intro_research"></a>
	<h3>Research</h3>
	<p>
		Dont take my word for it!
		Research others opinions and methods.
		Look at my <a href="reference">references</a>,
		look at <a href="http://www.postfix.org/docs.html"
			>Postfix.org's howtos</a>,
		read the excellent books available
		(E.g. Kyle's or Hildebrandt's),
		search the web or read the proper
		<a href="http://www.postfix.org/docs.html">documentation</a>.
	</p>
	<p>
		If you refer to this howto in your own document,
		or find useful links, then
		<a href="#contact">let me know</a>.
	</p>


	<a name="intro_ego"></a>
	<h3>Donate</h3>
<table border="0">
	<tr>
		<td rowspan="2">
			<p>
				If you found this howto very useful,  spread the word and help others?
			</p>
			<p>
				If this howto was exceptionally useful why not donate me some <b><i>beer</i></b> money?
			</p>
			<p>
				Or buy a <a href="#install">postfix book</a> using my <a href="#install">amazon affiliate links</a> further down?
			</p>
			<p>
				Or buy a t-shirt from <a href="http://shirts.flurdy.com">my t-shirt shop</a>?
			</p>
			<p>
				Otherwise <a href="#contact">send me</a> a <b><i>Thank You</i></b> note?
			</p>
		</td>
		<td colspan="3">
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="image" src="https://www.paypal.com/en_US/i/btn/x-click-but04.gif"
border="0" name="submit" alt="PayPal" />
<input type="hidden" name="encrypted" value="-----BEGIN PKCS7-----
MIIHNwYJKoZIhvcNAQcEoIIHKDCCByQCAQExggEwMIIBLAIBADCBlDCBjjELMAkG
A1UEBhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQw
EgYDVQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UE
AxQIbGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20CAQAwDQYJ
KoZIhvcNAQEBBQAEgYCgEfxd9glNwwnRA2oazEVXN7IYJF6P+QZxucKi5GPIhDVC
ygZb0mkY/iPHV0FvVCWlBySIpthS62N6sKETS873pydUZDy/3GpkBCgm8Kf+9Joh
ZnixaRsy/h8mnt+BH8WcxgvSyad09l7mxQe6K1gWd0KoJUQTWXBxpjZgQOjQFjEL
MAkGBSsOAwIaBQAwgbQGCSqGSIb3DQEHATAUBggqhkiG9w0DBwQI2JfMa1Ko95qA
gZCxorYhC1DDzc3L7tSe0Dab4/7dAiy9GN5Kjmizd6gS2gsL2SEw2J3P+HbHC7QB
IR5dOLfZ+Z9wdqX7vbJduCn8SllC4Jqv1AgbiRXVggWnJyJlam4eqJE0qGFstAiH
6Rkwq7ESZTSi6Wr7TFiHqC2d8nHW2VX8GmL3Ux/FviFyP/1qu+V0CF9UmnWbqNks
UNygggOHMIIDgzCCAuygAwIBAgIBADANBgkqhkiG9w0BAQUFADCBjjELMAkGA1UE
BhMCVVMxCzAJBgNVBAgTAkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYD
VQQKEwtQYXlQYWwgSW5jLjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQI
bGl2ZV9hcGkxHDAaBgkqhkiG9w0BCQEWDXJlQHBheXBhbC5jb20wHhcNMDQwMjEz
MTAxMzE1WhcNMzUwMjEzMTAxMzE1WjCBjjELMAkGA1UEBhMCVVMxCzAJBgNVBAgT
AkNBMRYwFAYDVQQHEw1Nb3VudGFpbiBWaWV3MRQwEgYDVQQKEwtQYXlQYWwgSW5j
LjETMBEGA1UECxQKbGl2ZV9jZXJ0czERMA8GA1UEAxQIbGl2ZV9hcGkxHDAaBgkq
hkiG9w0BCQEWDXJlQHBheXBhbC5jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJ
AoGBAMFHTt38RMxLXJyO2SmS+Ndl72T7oKJ4u4uw+6awntALWh03PewmIJuzbALS
csTS4sZoS1fKciBGoh11gIfHzylvkdNe/hJl66/RGqrj5rFb08sAABNTzDTiqqNp
JeBsYs/c2aiGozptX2RlnBktH+SUNpAajW724Nv2Wvhif6sFAgMBAAGjge4wgesw
HQYDVR0OBBYEFJaffLvGbxe9WT9S1wob7BDWZJRrMIG7BgNVHSMEgbMwgbCAFJaf
fLvGbxe9WT9S1wob7BDWZJRroYGUpIGRMIGOMQswCQYDVQQGEwJVUzELMAkGA1UE
CBMCQ0ExFjAUBgNVBAcTDU1vdW50YWluIFZpZXcxFDASBgNVBAoTC1BheVBhbCBJ
bmMuMRMwEQYDVQQLFApsaXZlX2NlcnRzMREwDwYDVQQDFAhsaXZlX2FwaTEcMBoG
CSqGSIb3DQEJARYNcmVAcGF5cGFsLmNvbYIBADAMBgNVHRMEBTADAQH/MA0GCSqG
SIb3DQEBBQUAA4GBAIFfOlaagFrl71+jq6OKidbWFSE+Q4FqROvdgIONth+8kSK/
/Y/4ihuE4Ymvzn5ceE3S/iBSQQMjyvb+s2TWbQYDwcp129OPIbD9epdr4tJOUNiS
ojw7BHwYRiPh58S1xGlFgHFXwrEBb3dgNbMUa+u4qectsMAXpVHnD9wIyfmHMYIB
mjCCAZYCAQEwgZQwgY4xCzAJBgNVBAYTAlVTMQswCQYDVQQIEwJDQTEWMBQGA1UE
BxMNTW91bnRhaW4gVmlldzEUMBIGA1UEChMLUGF5UGFsIEluYy4xEzARBgNVBAsU
CmxpdmVfY2VydHMxETAPBgNVBAMUCGxpdmVfYXBpMRwwGgYJKoZIhvcNAQkBFg1y
ZUBwYXlwYWwuY29tAgEAMAkGBSsOAwIaBQCgXTAYBgkqhkiG9w0BCQMxCwYJKoZI
hvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0wNDAzMTYxNTA3MjhaMCMGCSqGSIb3DQEJ
BDEWBBTbFddl3wwdQ0MTuJUSk4S8P3vPYDANBgkqhkiG9w0BAQEFAASBgGMa41i6
fyK4TnKfops9ao3lQBVaxQ4tQi02mzVPNQ3H/rA41uHhdosuDnsFXjifbYbzmFuq
2KsqMY4RazjlOjSz/sAmz3rxJ+19N0jJbT282t1lFiPI08F1+EIq6bK2qFtXHJb6
y8JYIMG1EKR9YeTQVLalcV2nYjRM/0GXuj0O
-----END PKCS7-----
" />
</form>
		</td>
	</tr>
	<tr>
		<td align="center">
			<a href="http://shirts.flurdy.com/uk"><img style="border: 1px solid black;"
			src="http://image.spreadshirt.com/image-server/image/product/3876780/view/1/type/png/width/190/height/190"
			onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/3876780/view/1/type/png/width/190/height/190'"
			onmouseover="this.src='http://image.spreadshirt.com/image-server/image/design/3120666/type/png/width/190/height/190'"
				width="60" height="60" border="1" alt="no fix puta" align="left" title="t-shirt by flurdy (UK)" vspace="5" hspace="5"/></a>
			<h6><a href="http://shirts.flurdy.com/uk">UK</a></h6>
		</td>
		<td align="center">
			<a href="http://shirts.flurdy.com/us"><img  style="border: 1px solid black;"
			src="http://image.spreadshirt.com/image-server/image/product/4198589/view/1/type/png/width/190/height/190"
			onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/4198589/view/1/type/png/width/190/height/190'"
			onmouseover="this.src='http://image.spreadshirt.com/image-server/image/design/3257345/type/png/width/190/height/190'"
				width="60" height="60" border="1" alt="kill bill" align="left" title="t-shirt by flurdy (US)" vspace="5" hspace="5"/></a>
			<h6><a href="http://shirts.flurdy.com/us">US</a></h6>
		</td>
		<td align="center">
			<a href="http://shirts.flurdy.com/eu"><img  style="border: 1px solid black;"
			src="http://image.spreadshirt.net/image-server/image/product/8968630/view/1/type/png/width/190/height/190"
			onmouseout="this.src='http://image.spreadshirt.net/image-server/image/product/8968630/view/1/type/png/width/190/height/190'"
			onmouseover="this.src='http://image.spreadshirt.net/image-server/image/design/233902/type/png/width/190/height/190'"
				width="60" height="60" border="1" alt="" align="left" title="t-shirt by flurdy (EU)" vspace="5" hspace="5"/></a>
			<h6><a href="http://shirts.flurdy.com/eu">EU</a></h6>
		</td>
	</tr>
</table>
	<br clear="all" />
</div>
<h6><a href="#top">Return to top</a>.</h6>




<a name="software"></a>
<h2>Software</h2>
<div class="section">
	<div style="float: right;">
		<a href="http://www.ubuntu.com"><img
			src="edition3/images/ubuntu-Logo-small.png"
			alt="Ubuntu" title="Ubuntu Linix OS"
			width="120" class="postfix" /></a><br />
		<a href="http://www.postfix.org"><img
			src="edition3/images/mysza.gif"
			alt="postfix" title="Postfix MTA"
			width="120" class="postfix" /></a><br />
		<a href="http://www.courier-mta.org/imap/"><img
			src="edition3/images/courier-imap.png"
			alt="Courier IMAP" title="Courier IMAP"
			width="120" class="postfix" /></a><br />
		<a href="http://www.mysql.com"><img
			src="edition3/images/mysql.png"
			alt="MySQL" title="MySQL database lookups"
			width="120" class="postfix" /></a><br />
		<a href="http://www.ijs.si/software/amavisd/"><img
			src="edition3/images/amavis-small.png"
			alt="amavisd-new" title="amavisd-new content checks"
			width="120" class="postfix" /></a><br />
		<a href="http://www.clamav.net"><img
			src="edition3/images/clam.png"
			alt="ClamAV" title="ClamAV anti-virus"
			width="120" class="postfix" /></a><br />
		<a href="http://spamassassin.apache.org"><img
			src="edition3/images/spam-small.png"
			alt="SpamAssassin" title="SpamAssassin anti-spam"
			width="120" class="postfix" /></a><br />
		<a href="http://www.squirrelmail.org"><img
			src="edition3/images/squirrel-small.jpg"
			alt="SquirrelMail" title="SquirrelMail webmail"
			width="120" class="postfix" /></a><br />
		<a href="http://www.roundcube.net"><img
			src="edition9/images/roundcube_logo.png"
			alt="Roundcube" title="Roundcube webmail"
			width="120" class="postfix" /></a><br />
		<a href="http://www.phpmyadmin.net"><img
			src="edition3/images/phpmyadmin.gif"
			alt="admin" title="phpMyAdmin"
			width="45" height="45" class="postfix" /></a>
		<a href="http://spf.pobox.com"><img
			src="edition3/images/spfsmtp-small.png"
			alt="SPF" title="SPF Sender ID"
			width="45" height="45" class="postfix" /></a><br />
		<a href="http://www.gnupg.org"><img
			src="edition3/images/gnupg-small.png"
			alt="GnuPG" title="GnuPG encryption"
			width="45" height="45" class="postfix" /></a>
		<a href="http://asg.web.cmu.edu/sasl/"><img
			src="edition3/images/cyrus-sasl-small.jpg"
			alt="SASL" title="Cyrus-SASL authentication"
			width="45" height="45" class="postfix" /></a><br />
	</div>

	<h4>
		What software packages have/will I use and why.
	</h4>
	<ul>
		<li>
			<h4>OS: <b>Ubuntu Linux</b></h4>
			<h6><a href="http://www.ubuntu.com">www.ubuntu.com</a></h6>
			<p>
				Ah the age old distro argument...
				Thankfully this set up should work on most distros.
				I used to base this howto on Mandrake(now Mandriva),
				and I started this new edition on a Gentoo box.
				But I don't have the patience for Gentoo,
				nor the money to stay with Mandriva Power editions.
				Why Ubuntu? Its free, simple and slick.
				As Ubuntu is derived from debian the installations
				used here will be apt-get based.
				Please refer to my other editions for details on RPM
				or source based installations.
			</p>
		</li>
		<li>
			<h4>MTA: <b>Postfix</b></h4>
			<h6><a href="http://www.postfix.org">www.postfix.org</a></h6>
			<p>
				Simple, free and slick.
				Yup I am a sucker for anything that works easily.
				Postfix is powerfull, well established,
				but not too bloated,
				and is security concious from the start.
			</p>
		</li>
		<li>
			<h4>Pop/IMAP: <b>Courier IMAP</b></h4>
			<h6><a href="http://www.courier-mta.org/imap/">www.courier-mta.org/imap/</a></h6>
			<p>
				My first mail server installtion was with Courier.
				I have not found a reason to change this as again
				it is simple, and free.
			</p>
		</li>
		<li>
			<h4>Database: <b>MySQL</b></h4>
			<h6><a href="http://www.mysql.com">www.mysql.com</a></h6>
			<p>
				Although I use Firebird for my application development,
				(or Hibernate/C-JDBC hybrids),
				MySQL is well supported for the sort of lookups required
				in a mail server.
			</p>
		</li>
		<li>
			<h4>Content Check: <b>Amavisd-new</b></h4>
			<h6><a href="http://www.ijs.si/software/amavisd/">www.ijs.si/software/amavisd/</a></h6>
			<p>
				Easy plug in solution for spam, virus checking etc.
			</p>
		</li>
		<li>
			<h4>Anti-Spam: <b>SpamAssassin</b></h4>
			<h6><a href="http://spamassassin.apache.org">spamassassin.apache.org</a></h6>
			<p>
				Powerfull renowned spam fighting tool.
			</p>
		</li>
		<li>
			<h4>Anti-Virus: <b>ClamAV</b></h4>
			<h6><a href="http://www.clamav.net">www.clamav.net</a></h6>
			<p>
				Free virus scanner that can be trusted and includes update daemon.
			</p>
		</li>
		<li>
			<h4>Authentication: <b>Cyrus SASL</b></h4>
			<h6><a href="http://www.imc.org/ietf-sasl/">www.imc.org/ietf-sasl/</a></h6>
			<p>
				Secure and trusted crypthography technology
				for authentication of SMTP traffic.
			</p>
		</li>
		<li>
			<h4>PostGrey</h4>
			<h6><a href="http://isg.ee.ethz.ch/tools/postgrey/">isg.ee.ethz.ch/tools/postgrey/</a></h6>
			<p>
				Postgrey is an excellent little script to stop 99% of all spam.
				All it does is on first contact for specific from-to combinations,
				tells the sender server to try again in a little while,
				which most spammers cant afford to do.
				When proper servers try again after a few minutes it lets it through.
			</p>
		</li>
		<li>
			<h4>Encryption: <b>TLS</b></h4>
			<h6><a href="http://www.ietf.org/html.charters/tls-charter.html">www.ietf.org/html.charters/tls-charter.html</a></h6>
			<p>
				Secure and trusted crypthography technology
				for encryption of SMTP traffic.
				Not too be confused with client encryption technology
				like GnuPG and S/MIME. They are covered in the
				<a href="#extend">extend</a> section.
				Formerly referenced as SSL.
			</p>
		</li>
		<li>
			<h4>WebMail: <b>SquirrelMail</b> or <b>Roundcube</b></h4>
			<h6><a href="http://www.squirrelmail.org">www.squirrelmail.org</a></h6>
			<p>
				Easy to set up php based web mail client.
				Extensive plugin selection.
			</p>
			<h6><a href="http://www.roundcube.net">www.roundcube.net</a></h6>
			<p>
				Ajaxified prettier web mail client.
				Not quite as solid as SquirrelMail.
			</p>
		</li>
		<li>
			<h4>Platform: <b>Amazon ec2</b></h4>
			<h6><a href="http://aws.amazon.com/ec2">aws.amazon.com/ec2</a></h6>
			<p>
				This guide can be installed locally, co-located or in the cloud.<br/>
				<a href="http://flurdy.com/docs/ec2/">My preference is ec2</a>,
				and I provide <a href="#ec2">ec2 based examples</a>,
				however it makes no difference where you install your mail server.
			</p>
		</li>
	</ul>
		<p>
			Please see <a href="edition5.html#app_links">software links appendix</a> for further information
			about these software packages. In that section there is more links to
			documentation or forums, and viable alternatives, downloadable packages, versions details etc.
		</p><p>
			Further software and tweaks are discussed in the
			<a href="#extend">extension section</a>.
		</p><p>
			Also review other peoples opinion on these packages via my <a href="edition5.html#references">references</a>.
			</p>
</div>
<h6><a href="#top">Return to top</a>.</h6>





<a name="install"></a>
<h2>Installation</h2>
<div class="section">

	<!--
	<div id="amazon" class="ads">
		<iframe src="http://rcm-uk.amazon.co.uk/e/cm?t=ivarssite-21&o=2&p=14&l=st1&mode=books-uk&search=postfix&fc1=&=1&lc1=&lt1=&f=ifr&bg1="
				marginwidth="0" marginheight="0" width="160" height="600"
				border="0" frameborder="0" style="border:none;"
				scrolling="no"></iframe>
	</div>
	-->

	<ul>
		<li><p><a href="#install_distro">Distrobution</a></p></li>
		<li><p><a href="#install_Base">Base Install</a></p></li>
		<li><p><a href="#install_repos">Repositories</a></p></li>
		<li><p><a href="#install_pack">Packages</a></p></li>
	</ul>

	<iframe src="http://rcm.amazon.com/e/cm?t=flurdy-20&o=1&p=48&l=st1&mode=books&search=postfix%20email&nou=1&fc1=000000&lt1=_top&lc1=3366FF&bg1=FFFFFF&f=ifr" marginwidth="0" marginheight="0" width="728" height="90" border="0" frameborder="0" style="border:none;" scrolling="no"></iframe>

	<a name="install_distro"></a>
	<h3>Distribution</h3>
	<p>
		This section is different for every distribution and for every version.
	</p>
	<p>
		This howto is based on <b>Ubuntu</b> and its base of debian which uses apt-get.
		Therefore this section uses apt packages to its fullest.
	</p>
	<p>
		For other installation method please refer to previous edition's
		<a href="http://flurdy.com/docs/postfix/edition5.html#app_links">software links</a>
		and your own distribution
		for the documention for other ways of installing.
		My <a href="edition2.html">2nd edition</a>(outdated) has instructions
		for Mandriva, general RPM and tarball compiling.
	</p>
	<p>
		To follow the rest of this howto with another distribution,
		you need to ensure all your
		packages have been installed with the same modules,
		E.g MySQL lookup on postfix and sasl, php in apache etc.
	</p>
	<p>
		I have set up mail servers using the 32bit and 64bit x86 platforms,
		and if all the packages are available then other,
		E.g. Mac platforms should work too.
	</p>

	<a name="install_base"></a>
	<h3>Base Install</h3>
	<p>
		With installing Ubuntu you have a choice of which base system to install.
		You may choose server or desktop image or very basic setups.
		I will assume a server install, but it should not differ.
	</p>

	<p>
		If you have chosen an <a href="#ec2">ec2 based server</a> you should follow <a href="#ec2">my ec2 suggestions</a> first.
	</p>

	<p>
		I strongly suggest choosing the latest <a href="https://wiki.ubuntu.com/LTS">LTS version</a> of Ubuntu, not the versions in between. Once this is set up you will tinker very little with it, and it will quickly be annoying to upgrade distributions once a year.
	</p>

	<p>
		Ps. Please note that after a while Ill stop specifying the use of <a href="http://help.ubuntu.com/community/RootSudo">sudo</a>,
		as it is up to yourselves if you use it or use a priviliged user, e.g. root. My advice is to use 'sudo'.
	</p>


	<a name="install_repos"></a>
	<h3>Repositories</h3>

	<p>
		For assistance with repositories, refer to <a href="http://wiki.ubuntu.com/AddingRepositoriesHowto">this article on ubuntu's wiki</a>.
	</p>
	<p>
		A  <a href="edition5.html#install_repos">previous edition</a>
		discussed repository configuration in more detail.
	</p>
	<p>
		But basically for this you need <i>main</i> and <i>universe</i>, and I also throw in the other <i>"safe"</i> ones: <i>restricted</i> and <i>multiverse</i> (and <i>partner</i>, when available).
		<code>sudo vi /etc/apt/sources.list </code>
		If main and universe already is listed,
		this is a quick find and replace to add the others all over:
		<code>:%s/main un/main restricted multiverse un/g</code>
	</p>
	<p>
		As mentioned in the <a href="edition5.html#install_repos">previous edition</a>
		you also might want to find a repository closer to your server.
	</p>





	<a name="install_pack"></a>
	<h3>Packages</h3>
	<p>
		You need to install a whole bunch of packages.
		We will install them bit by bit.
		But first check your package sources are correctly pointing to <b><i>main multiverse restricted universe</i></b>
		repositories of your current Ubuntu version.
		<code>sudo vi /etc/apt/sources.list</code>
		Secondly update your current system:
		<code>sudo apt-get update
sudo apt-get upgrade</code>
	</p>

	<p>
		<strong>Note</strong>: <em>aptitude</em> is no longer supplied in the base install of Ubuntu.
		This is due to some <a href="https://bugs.launchpad.net/ubuntu/+source/aptitude/+bug/831768">concurrency issues</a>.
		Some part of this document may still refer to aptitude.
		You should use the original <i>apt-get</i> instead.
	</p>

	<!--
	<h5>MySQL</h5>
	<p>
		First we'll install MySQL
		<code>sudo apt-get install mysql-client mysql-server</code>
		This will prompt you for a root password.
		Choose someting wise and remember it!
		For purpose of this tutorial I will set it to <b><i>rootPASSWORD</i></b>
	</p>
	<h5>Postfix</h5>
	<p>
		Then we'll install postfix
		<code>sudo apt-get install postfix postfix-mysql</code>
		This will prompt you to choose type of email server.
		Select <b><i>internet site</i></b>
		It will also  suggest a server name. Correct this if needed.
	</p>
	<h5>SASL</h5>
	<code>sudo apt-get install libsasl2-modules libsasl2-modules-sql libgsasl7\
				libauthen-sasl-cyrus-perl sasl2-bin libpam-mysql</code>
	<h5>	ClamAV</h5>
	<p>
		<code>sudo apt-get install clamav-base libclamav6 clamav-daemon clamav-freshclam</code>
		(Earlier vesions of Ubuntu may use libclamav5)
	</p>

	<h5>Amavis, SpamAssassin, postgrey</h5>
	<p>
		<code>sudo apt-get install amavisd-new
sudo apt-get install spamassassin spamc
sudo apt-get install postgrey</code>
	</p>
	-->

	<!--
	<h5>SquirrelMail</h5>
	<code>sudo apt-get install squirrelmail squirrelmail-locales php-pear php5-cli</code>
	<h5>Roundcube</h5>
	<code>sudo apt-get install roundcube roundcube-mysql roundcube-plugins php-pear php5-cli</code>

	<h5>phpMyAdmin</h5>
	<code>sudo apt-get install phpmyadmin</code>
	<p>
		Enter <i>Yes</i> to set it up, enter root mysql password, enter a phpmyadmin mysql user password twice.
		Accept apache2 as the web server.
	</p>

	<h5>ShoreWall</h5>
	<code>sudo apt-get install shorewall shorewall-doc
<span class="comment"># for earlier ubuntu versions use package <i>shorewall-common shorewall-perl shorewall-doc</i> instead</span></code>
	<p>
		Amazon provides a firewall/ access control for its  servers,
		so not always needed then, but nice to have.
		And in all others situations; a must have.
	</p>
	<p>

	</p>
	-->
	<!--
	<h5>Courier</h5>
	<p>
		<code>sudo apt-get install courier-base courier-authdaemon courier-authlib-mysql \
			courier-imap courier-imap-ssl courier-ssl</code>
		will prompt you about webdirectories. You can say no to this.
		It will also warn you about the certificate location. Ignore it.
	</p>
	-->


	<h5>Additional packages</h5>
	<p>
		I also install a few other packages that I personally prefer.
		But nothing todo with the mail server.
		<code>sudo apt-get install vim mutt lynx curl git</code>
	</p>


	<h5>Package status</5>
	<p>
		To find out which packages you may have installed,
		you can use for example:
		<code>sudo dpkg --list | grep <i>postfix</i></code>
		or
		<code>sudo apt-get search postfix</code>
	</p>


<!--
	<div class="note">
	<h5>EC2 Bundle</h5>
	<p>
		My AMI <b><i><a href="#ec2_ami">flurdy-amis/ubuntu-mail-server-clean</a></i></b>
		is based on Canonical's official Ubuntu with these basic mail server packages installed.
	</p>
	</div>
-->

</div>
<h6><a href="#top">Return to top</a>.</h6>




<a name="config"></a>
<h2>Configuration</h2>

<div class="section">

	<div style="float:right; padding-right: 15px;">
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/I-read-your-email-3691300"><img
				style="border: 1px solid black; background-color:white; padding:3px;"
				src="http://image.spreadshirt.com/image-server/v1/compositions/4068110/views/1,width=280,height=280,appearanceId=54.png/i-read-your-email_design.png"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/v1/compositions/4068110/views/1,width=280,height=280,appearanceId=54.png/i-read-your-email_design.png'"
				onmouseover="this.src='http://image.spreadshirt.com/image-server/image/product/4068110/view/1/type/png/width/190/height/190'"
				width="150" height="150" border="0" alt="I read your email"
				align="right" title="t-shirt by flurdy" vspace="5" hspace="5"/></a>
	</div>


	<ul>
		<li>
			<h5><a href="#config-simple">Core/Simple</a></h5>
			<ul>
				<li><p><a href="#config-simple-firewall">Firewall (Shorewall)</a></p></li>
				<li><p><a href="#config-simple-mta">MTA (Postfix)</a></p></li>
				<li><p><a href="#config-simple-database">Database (MySQL)</a></p></li>
				<li><p><a href="#config-simple-imap">Pop/IMAP (Courier)</a></p></li>
			</ul>
		</li>
		<li>
		<h5><a href="#config-adv">Advanced</a></h5>
			<ul>
				<li><p><a href="#config-adv-content">Content Checks (amivisd-new)</a></p>
					<ul>
						<li><p><a href="#config-adv-spam">Anti-Spam(SpamAssassin)</a></p></li>
						<li><p><a href="#config-adv-virus">Anti-Virus (ClamAV)</a></p></li>
						<li><p><a href="#config-adv-policy">Policy Check (PostGrey)</a></p></li>
					</ul>
				</li>
			</ul>
		</li>
		<li>
			<h5><a href="#config-secure">Secure</a></h5>
			<ul>
				<li><p><a href="#config-secure-auth">Authentication (SASL)</a></p></li>
				<li><p><a href="#config-secure-crypt">Encryption (TLS)</a></p></li>
			</ul>
		</li>
		<li><p><a href="#config-extra-webmail">Webmail (SquirrelMail)</a></p></li>
		<li><p><a href="#config-extra-admin">Administration (phpMyAdmin)</a></p></li>
		<li>
			<h5><a href="#config-external">External</a></h5>
			<ul>
				<li><p><a href="#config-external-domain">Domain name</a></p></li>
				<li><p><a href="#config-external-dns">DNS</a></p></li>
			</ul>
		</li>
	</ul>



	<a name="config-simple"></a>
	<h3>Simple mail server</h3>
	<p>
		Now lets configure a simple mail server using some of
		the packages installed.
	</p>

	<a name="config-simple-firewall"></a>
	<h3>Firewall</h3>
	<h4>Shorewall</h4>
	<p>
		Not essential for an EC2 image.
		It is essential for a normal server.
		UFW is bundled with recent Ubuntu distributions,
		but I still prefer Shorewall for servers.
	</p>

	<h5>Installation</h5>
	<code>sudo apt-get install shorewall shorewall-doc
<span class="comment"># for earlier ubuntu versions use package <i>shorewall-common shorewall-perl shorewall-doc</i> instead</span></code>
	<p>
		Amazon provides a firewall/ access control for its  servers,
		so not always needed then, but nice to have.
		And in all others situations; a must have.
	</p>
	<h5>Configuration</h5>
	<p>
		Basically at first you want to only allow SSH.
		Then SMTP and IMAP from your IP only.
	</p>
	<p>
		When you are confident that the mail server is secure,
		you can open SMTP to the world.
		If you prefer you can also open IMAP to the world,
		unless you have a very small client IP range.
	</p>
	<p>
		Later you may open web access to the webmail and admin gui.
		This you may also restrict to specific IPs.
	</p>
	<h5>SSH only</h5>
	<p>
		By default Shorewall in Ubuntu has an empty set up.
		You can find the default values for Shorewall in
		<i>/usr/share/shorewall/configfiles</i>.
		And examples in <i>/usr/share/doc/shorewall/examples</i>.
		We will create a basic set up.
	</p>
	<p>
		First configure which network adapters we are accessing the net.
		<code>cp /usr/share/doc/shorewall/default-config/interfaces /etc/shorewall/
vi /etc/shorewall/interfaces</code>
		<code>net     eth0            detect          dhcp,tcpflags,logmartians,nosmurfs</code>
	</p>
	<p>
		Then we will configure network zones
		<code>cp /usr/share/doc/shorewall/default-config/zones /etc/shorewall/
vi /etc/shorewall/zones</code>
		Add the firewall if not there and the internet as a zone.
		<code>fw	firewall
<span class="comment"># loc 	ipv4</span>
net     ipv4</code>
	</p>
	<p>
		Then if needed to specify hosts you can do it in this file.
		E.g. If you wanto specify what is your home IP etc.
		<code>cp /usr/share/doc/shorewall/default-config/hosts /etc/shorewall/
vi /etc/shorewall/hosts</code>
		<code><span class="comment"># loc	eth0:192.168.0.0/24</span></code>
	</p>
	<p>
		Then set what is the default policy for firewall access.
		<code>cp /usr/share/doc/shorewall/default-config/policy /etc/shorewall/
vi /etc/shorewall/policy</code>
		<code>$FW             net             ACCEPT
net             $FW             DROP            info
net             all             DROP            info
<span class="comment"># The FOLLOWING POLICY MUST BE LAST</span>
all             all             REJECT          info</code>
	</p>
	<p>
		For safety in case it goes down.
	<code>cp /usr/share/doc/shorewall/default-config/routestopped /etc/shorewall/
vi /etc/shorewall/routestopped</code>
		<code>eth0            0.0.0.0                 routeback</code>
		You may put in a netmask of your ip range if you are more concerned.
	</p>
	<p>
		Now for the main firewall rules.
		You can find predetermined macro rules for Shorewall in
		<i>/usr/share/shorewall</i>.
		<code>cp /usr/share/doc/shorewall/default-config/rules /etc/shorewall/
vi /etc/shorewall/rules</code>
		<code>SSH/ACCEPT      net             $FW</code>
	</p>
	<h5>Open for business</h5>
	<p>
		Once your server is working
		come back to this step and
		open up SMTP and Web access to others.	</p>
		<code>vi /etc/shorewall/rules</code>
		<code>Ping/ACCEPT     net             $FW

# Permit all ICMP traffic FROM the firewall TO the net zone
ACCEPT          $FW             net             icmp

# mail lines
SMTP/ACCEPT     net             $FW
SMTPS/ACCEPT    net             $FW
Submission/ACCEPT       net             $FW
IMAP/ACCEPT     net             $FW
IMAPS/ACCEPT    net             $FW

#web
Web/ACCEPT      net             $FW</code>
	</p>

	<p>
		Firewall configuring is always risky business,
		as it is easy to lock yourself out.
		To test the setup syntax, run
		<code>shorewall check</code>
		Restart it with
		<code>/etc/init.d/shorewall restart</code>
	</p>
	<p>
		Then to switch it on during boot:
		<code>vi /etc/default/shorewall</code>
		<code>startup=1</code>
	</p>
	<p>
		For more details on IP Tables and Shorewall,
		look up its <a href="http://www.shorewall.net">website</a>.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>

<script type="text/javascript"><!--
google_ad_client = "pub-7805345644641760";
/* postfix ed7  banner1 */
google_ad_slot = "9524380180";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>


	<a name="config-simple-database"></a>
	<h3>Database</h3>
	<h4>MySQL</h4>
	<h5>Installation</h5>
	<p>
		<code>sudo apt-get install mysql-client mysql-server</code>
		This will prompt you for a root password.
		Choose someting wise and remember it!
		For purpose of this tutorial I will set it to <b><i>rootPASSWORD</i></b>
	</p>

	<h5>Configuration</h5>
	<p>
		Now we will need to create the tables for thos lookups just specified.
		First you need to create a user to use in MySQL for mail only.
		Then you need to create the database,
		Take note of your chosen mail username and password.
		You will need the password you specified for <b><i>root</i></b> during MySQL package installation.
	</p>
	<p>
	<code><span class="comment"># If not already done (in package installation)...</span>
mysqladmin -u root -p password <i>new_password</i>
<span class="comment"># log in as root</span>
mysql -u root -p
<span class="comment"># then enter password for the root account when prompted</span>
<span class="reply">Enter password:</span>
<span class="comment"># then we create the mail database</span>
create database maildb;
<span class="comment"># then we create a new user: "mail"</span>
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP
ON maildb.* TO 'mail'@'localhost' IDENTIFIED by '<i>mailPASSWORD</i>';
GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP
ON maildb.* TO 'mail'@'%' IDENTIFIED by '<i>mailPASSWORD</i>';
exit;</code>
		Obviously replace <b><i>mailPASSWORD</i></b> with your chosen password!
	</p>
	<p>
		Then you will need to create these tables:
		<ul>
			<li><p>aliases</p></li>
			<!-- li>backups</li -->
			<li><p>domains</p></li>
			<!-- li>relocated</li -->
			<li><p>users</p></li>
			<!-- li>address</li>
			<li>userprefs</li -->
		</ul>
	</p>
	<p>
		We will create more later on for further extensions,
		but only these are relevant now.
	</p>

	<p>
		Log in to mysql as the new mail user
		<code>mysql -u mail -p maildb
<span class="comment"># enter the newly created password</span>
<span class="reply">Enter password:</span></code>
	</p>
	<p>
		Then run this commands to create the tables:
	</p>
	<code>CREATE TABLE `aliases` (
`pkid` smallint(3) NOT NULL auto_increment,
`mail` varchar(120) NOT NULL default '',
`destination` varchar(120) NOT NULL default '',
`enabled` tinyint(1) NOT NULL default '1',
PRIMARY KEY  (`pkid`),
UNIQUE KEY `mail` (`mail`)
) ;</code>
	<code>CREATE TABLE `domains` (
`pkid` smallint(6) NOT NULL auto_increment,
`domain` varchar(120) NOT NULL default '',
`transport` varchar(120) NOT NULL default 'virtual:',
`enabled` tinyint(1) NOT NULL default '1',
PRIMARY KEY  (`pkid`)
) ;</code>
	<code>CREATE TABLE `users` (
`id` varchar(128) NOT NULL default '',
`name` varchar(128) NOT NULL default '',
`uid` smallint(5) unsigned NOT NULL default '5000',
`gid` smallint(5) unsigned NOT NULL default '5000',
`home` varchar(255) NOT NULL default '/var/spool/mail/virtual',
`maildir` varchar(255) NOT NULL default 'blah/',
`enabled` tinyint(3) unsigned NOT NULL default '1',
`change_password` tinyint(3) unsigned NOT NULL default '1',
`clear` varchar(128) NOT NULL default 'ChangeMe',
`crypt` varchar(128) NOT NULL default 'sdtrusfX0Jj66',
`quota` varchar(255) NOT NULL default '',
`procmailrc` varchar(128) NOT NULL default '',
`spamassassinrc` varchar(128) NOT NULL default '',
PRIMARY KEY  (`id`),
UNIQUE KEY `id` (`id`)
) ;</code>

	<p>
		The last few fields in the <b><i>users</i></b> table are not required,
		but useful if you extend later.
	</p>

	<code><span class="comment"># To visualise the tables created:</span>
describe aliases; describe domains; describe users;
<span class="comment"># then quit mysql</span>
exit;</code>

	<p>
		Next is to edit the MySQL's <b><i>my.cnf</i></b> file.
		In Ubuntu/debian this is created by default.
		In Mandrake I had to manually create a blank one in /etc.
		But we need to configure it, so:
		<code>sudo vi /etc/mysql/my.cnf</code>
		In previous version you needed to comment out this line
		<code class="document"><span class="comment">#skip-networking</span></code>
		However in todays file the default is to bind the
		address to localhost, which is fine.
		<code class="documen">bind-address = 127.0.0.1</code>
		It is very useful at the start to log any SQL calls that makes it to MySQL.
		So enable these lines:
		<code class="document">general_log_file = /var/log/mysql/mysql.log
general_log = 1</code>
		Then in a few weeks comment it out when everything is working,
		as it slows mysql down
	</p>

	<p>
		Restart MySQL to make sure its picking up the new settings.
		<code>sudo /etc/init.d/mysql restart</code>
	</p>
	<h6><a href="#top">Return to top</a>.</h6>




	<a name="config-simple-mta"></a>
	<h3>MTA</h3>
	<h4>Postfix</h4>
	<h5>Installation</h5>
	<p>
		<code>sudo apt-get install postfix postfix-mysql</code>
		This will prompt you to choose type of email server.
		Select <b><i>internet site</i></b>
		It will also  suggest a server name. Correct this if needed.
	</p>
	<h5>Configuration</h5>
	<p>
		You should put the name of your server in this file
		<code>sudo vi /etc/mailname</code>
		Could be something like <i>smtp.domain.name</i>,
		where domain name obviously is replaced with your domain name.
	</p>
	<p>
		Now will open the main postfix configuration file:
		<code>sudo vi /etc/postfix/main.cf</code>
		Debian and Ubuntu already puts in some sensible default values in this file.
		You may need to comment some of them out if we put the same in as well.
	</p>

	<p>
		First specify the name of your server.
		<code><span class="comment"># This is already done in /etc/mailname
#myhostname= <i>mail.example.com</i></span></code>
		Next is the origin which is the domain appended to email from this machine,
		this can be your full servername, or domain name.
		<code><span class="comment"># myorigin=/etc/mailname</span>
myorigin=<i>example.com</i></code>
	</p>
	<p>
		Then decide what the greeting text will be.
		Enough info so it is useful,
		but not divulge everything to potential hackers.
		<code>smtpd_banner = $myhostname ESMTP $mail_name</code>
	</p>
	<p>
		Next you need to decide whether to send
		all outgoing mail via another SMTP server,
		or send them yourself.
		I send via my ISP's server,
		so it has to worry about the queuing etc.
		If you send it yourself then you are not reliant
		on 3rd party server.
		But you may risk more exposure and
		accidentally be blocked by spam blockers.
		And it is more work for your server.
		Also many servers block dynamic dns hosts,
		so you may find your server gets rejected.
		However choose whichever you are comfortable with.
		<code><span class="comment"># leave blank to do it yourself</span>
relayhost =</code><code><span class="comment"># or put it an accessible smtp server</span>
relayhost = <i>smtp.yourisp.com</i></code>
	</p>
	<p>
		Next is network details.
		You will accept connection from anywhere,
		and you only trust this machine
		<code>inet_interfaces = all
mynetworks_style = host</code>
	</p>
	<p>
		Next you can masquerade some outgoing addresses.
		Say your machine's name is <i>mail.domain.com</i>.
		You may not want outgoing mail to come from
		<i>username</i>@mail.example.com, as you'd prefer
		<i>username</i>@example.com.
		You can also state which domain not to masquerade.
		E.g. if you use a dynamic dns service,
		then your server address will be a subdomain.
		You can also specify which users not to masquerade.
		<code><span class="comment"># masquerade_domains = <i>mail.example.com www.example.com !sub.dyndomain.com</i>
# masquerade_exceptions = root</span></code>
	</p>
	<p>
		As we will be using virtual domains, these need to be empty.
		<code>local_recipient_maps =
mydestination =</code>

	</p>
	<p>
		Then will set a few numbers.

		<code><span class="comment"># how long if undelivered before sending warning update to sender		</span>
delay_warning_time = 4h
<span class="comment"># will it be a permanent error or temporary</span>
unknown_local_recipient_reject_code = 450
<span class="comment"># how long to keep message on queue before return as failed.</span>
<span class="comment"># some have 3 days, I have 16 days as I am backup server for some people</span>
<span class="comment"># whom go on holiday with their server switched off.</span>
maximal_queue_lifetime = 7d
<span class="comment"># max and min time in seconds between retries if connection failed</span>
minimal_backoff_time = 1000s
maximal_backoff_time = 8000s
<span class="comment"># how long to wait when servers connect before receiving rest of data</span>
smtp_helo_timeout = 60s
<span class="comment"># how many address can be used in one message.</span>
<span class="comment"># effective stopper to mass spammers, accidental copy in whole address list</span>
<span class="comment"># but may restrict intentional mail shots.</span>
smtpd_recipient_limit = 16
<span class="comment"># how many error before back off.</span>
smtpd_soft_error_limit = 3
<span class="comment"># how many max errors before blocking it.</span>
smtpd_hard_error_limit = 12</code>

	</p>

	<p>
		Now we can specify some restrictions.
		Be carefull that each setting is on one line only.
	</h4>

	<code><span class="comment"># Requirements for the HELO statement</span>
smtpd_helo_restrictions = permit_mynetworks, warn_if_reject reject_non_fqdn_hostname,
		reject_invalid_hostname, permit
<span class="comment"># Requirements for the sender details</span>
smtpd_sender_restrictions = permit_mynetworks, warn_if_reject reject_non_fqdn_sender,
		reject_unknown_sender_domain, reject_unauth_pipelining, permit
<span class="comment"># Requirements for the connecting server </span>
smtpd_client_restrictions = reject_rbl_client sbl.spamhaus.org,
		reject_rbl_client blackholes.easynet.nl
<span class="comment"># Requirement for the recipient address</span>
smtpd_recipient_restrictions = reject_unauth_pipelining, permit_mynetworks,
		reject_non_fqdn_recipient, reject_unknown_recipient_domain,
		reject_unauth_destination, permit
smtpd_data_restrictions = reject_unauth_pipelining</code>
	</p>
	<p>
		Further restrictions:
		<code><span class="comment"># require proper helo at connections </span>
smtpd_helo_required = yes
<span class="comment"># waste spammers time before rejecting them</span>
smtpd_delay_reject = yes
disable_vrfy_command = yes</code>
	</p>
	<p>
		Next we need to set some maps and lookups for the virtual domains.
		<code><span class="comment"># not sure of the difference of the next two</span>
<span class="comment"># but they are needed for local aliasing</span>
alias_maps = hash:/etc/postfix/aliases
alias_database = hash:/etc/postfix/aliases
<span class="comment"># this specifies where the virtual mailbox folders will be located</span>
virtual_mailbox_base = /var/spool/mail/virtual
<span class="comment"># this is for the mailbox location for each user</span>
virtual_mailbox_maps = mysql:/etc/postfix/mysql_mailbox.cf
<span class="comment"># and this is for aliases</span>
virtual_alias_maps = mysql:/etc/postfix/mysql_alias.cf
<span class="comment"># and this is for domain lookups</span>
virtual_mailbox_domains = mysql:/etc/postfix/mysql_domains.cf
<span class="comment"># this is how to connect to the domains (all virtual, but the option is there)</span>
<span class="comment"># not used yet
# transport_maps = mysql:/etc/postfix/mysql_transport.cf</span></code>
	</p>

	<p>
		I currently restrict my servers to ip4 and avoid ip6 at the moment.
		(Or rather avoid flooding my logs with ip6 errors).
		Hopefully soon enough servers that they interact with will support 6 and I can support both.
	</p>

	<code>inet_protocols=ipv4</code>

	<p>
		You can (as in my older editions) use a lookup for the uid and gid of the owner of mail files.
		But I tend to have one owner(virtual), so instead add this:
		<code>virtual_uid_maps = static:5000
virtual_gid_maps = static:5000</code>
	</p>

	<p>
		You need to set up an alias file.
		This is only used locally,
		and not by your own mail domains.

	<code>sudo cp /etc/aliases /etc/postfix/aliases
# may want to view the file to check if ok.
# especially that the final alias, eg root goes
# to a real person
sudo postalias /etc/postfix/aliases</code>

	</p>
	<p>
		Next you need to set up the folder
		where the virtual mail will be stored.
		This may have already been done by the apt-get.
		And also create the user whom will own the folders.

	<code><span class="comment"># to add if there is not a virtual user</span>
sudo mkdir /var/spool/mail/virtual
sudo groupadd --system virtual -g 5000
sudo useradd --system virtual -u 5000 -g 5000
sudo chown -R virtual:virtual /var/spool/mail/virtual</code>
	</p>
	<p>
		Note: If using <a href="#ec2">Amazon ec2</a> you may want to move the mail spool
		to /mnt or an <a href="http://aws.amazon.com/ebs">EBS</a> location.
		You will need to symlink correctly afterwards.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>



	<h5>Postfix's MySQL configuration</h5>
	<p>
		Next we need to set up the files to access the lookups via the database.
		We will only set up a few now, and the rest later when/if needed:
	</p>

	<p>Edit(create) how to find the users mailbox location
	<code>sudo vi /etc/postfix/mysql_mailbox.cf</code></p>
	<code class="document">user=mail
password=<i>mailPASSWORD</i>
dbname=maildb
table=users
select_field=maildir
where_field=id
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>
<!--
	<p>Create how to find the user id (this step I will eventualy remove)
	<code>sudo vi /etc/postfix/mysql_uid.cf</code></p>

	<code>user=mail
password=<i>mailPASSWORD</i>
dbname=maildb
table=users
select_field=uid
where_field=id
hosts=127.0.0.1</code>

	<p>Create how to find the group id. (this step I will eventualy remove)
	<code>sudo vi /etc/postfix/mysql_gid.cf</code></p>

	<code>user=mail
password=<i>mailPASSWORD</i>
dbname=maildb
table=users
select_field=gid
where_field=id
hosts=127.0.0.1</code>
-->
	<p>Create how to find the email alias:
		<code>sudo vi /etc/postfix/mysql_alias.cf</code></p>

	<code class="document">user=mail
password=<i>mailPASSWORD</i>
dbname=maildb
table=aliases
select_field=destination
where_field=mail
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>

	<p>Create how to find the domains:
		<code>sudo vi /etc/postfix/mysql_domains.cf</code></p>

	<code class="document">user=mail
password=<i>mailPASSWORD</i>
dbname=maildb
table=domains
select_field=domain
where_field=domain
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>

	<p>
	<!--
		As you can see the 3 first are very similar,
		only the select_field changes. -->
		If you specify an ip in hosts,
		(as opposed to 'localhost')
		then it will communicate over tcp
		and not the mysql socket. (chroot restriction).
		<!--
		Actually you can avoid using separate uid and guid files
		as those details are the same for all, but I do anyway. -->
		Ps. remember to replace the passwords with your chosen mail user password.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>

	<div style="float:right; padding-right: 15px;">
			<a href="http://flurdy.spreadshirt.net/en/GB/Shop/Article/Index/article/NO-LOL-on-dickies-7609529"><img
				style="border: 1px solid black;"
				src="http://image.spreadshirt.net/image-server/image/product/8788774/view/2/type/png/width/190/height/190"
				width="90" height="90" border="0" alt="No LOL"
				align="right" title="t-shirt by flurdy (UK)" vspace="5" hspace="5"/></a>
	</div>
<br />
<br />



<script type="text/javascript"><!--
google_ad_client = "pub-7805345644641760";
/* postfix ed7  banner2 */
google_ad_slot = "3607487631";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>




	<a name="config-simple-imap"></a>
	<h3>Pop/IMAP</h3>

	<p>
		A normal mail server will need IMAP,
		however if your server is a backup or redirection only server
		then Courier is not needed.
	</p>


	<h4>Courier IMAP</h4>
	<p>Installation:</p>
	<p>
		<code>sudo apt-get install courier-base courier-authdaemon courier-authlib-mysql \
			courier-imap courier-imap-ssl courier-ssl</code>
		will prompt you about webdirectories. You can say no to this.
		It will also warn you about the certificate location. Ignore it.
	</p>
	<p>
		Please refer to <a href="edition5.html#conf_imap">previous edition</a>
		for more explanations. But below is the details of what you need to
		change.
	</p>
	<p>
		<code>sudo vi /etc/courier/authdaemonrc</code>
		Change to mysql mode.
		<code class="document">authmodulelist="authmysql"</code>
		Further down enable logging.
		<code class="document">DEBUG_LOGIN=2</code>
	</p>
	<p>
		<code>sudo vi /etc/courier/authmysqlrc</code>
		Changed user
		<code class="document">MYSQL_USERNAME mail</code>
		Changed password to whichever you have chosen
		<code class="document">MYSQL_PASSWORD <i>mailPASSWORD</i></code>
		Changed database
		<code class="document">MYSQL_DATABASE maildb</code>
		Changed users table
		<code class="document">MYSQL_USER_TABLE users</code>
		Keep commented in crypt pw
		<code class="document">MYSQL_CRYPT_PWFIELD crypt</code>
		Keep commented out clear pw
		<code class="document"><span class="comment"># MYSQL_CLEAR_PWFIELD clear</span></code>
		Added maildir
		<code class="document">MYSQL_MAILDIR_FIELD concat(home,'/',maildir)</code>
		Added where clause
		<code class="document">MYSQL_WHERE_CLAUSE enabled=1</code>
	</p>
	<p>
		Lastly you can have a look at the imapd file, but no changes is needed.
		<code>vi /etc/courier/imapd</code>
	</p>
	<h6><a href="#top">Return to top</a>.</h6>



	<h4>Summary</h4>

		<p>
			You now have a basic mail server!<br/>
		</p>
		<p>
			Before continuing to the advanced and secure mail server you <b>must</b> ensure the basic setup works.
			This will save you from <b>loads of pain</b> further on. <br/>
			It is very easy to make typos, miss tiny steps, unclear steps or simple actual errors in this howto.
		</p>
		<p>
		<ul>
			<li><p>Insert stub data from <a href="#data">data section</a></p></li>
			<li><p>Apply advice from <a href="#test">test section</a> judicously</p></li>
			<li><p>Ensure the mail server can receive email correctly first, then try sending.</p></li>
			<li><p>Once you are positive the mail has been received, the mail folders have been automatically created,<br/>
			 only then you should test if you can actually read the emails before proceding</p></li>
		</ul>

<!--
	<div class="note">
		<p>
			Ive created an EC2 bundle for this stage:
			<a href="#ec2_ami">flurdy-amis/ubuntu-mail-server-simple</a>.
		</p>
	</div>
-->

</div>
<h6><a href="#top">Return to top</a>.</h6>



<br />
<br />




<div class="section">

	<div class="tees">
			<a href="http://flurdy.spreadshirt.net/en/GB/Shop/Article/Index/article/wrong-evolution-7434008"><img
				src="http://image.spreadshirt.net/image-server/image/product/8601636/view/1/type/png/width/190/height/190"
				alt="wrong evolution"
				onmouseout="this.src='http://image.spreadshirt.net/image-server/image/product/8601636/view/1/type/png/width/190/height/190'"
				onmouseover="this.src='http://image.spreadshirt.net/image-server/image/design/5307374/type/png/width/190/height/190'"
				title="t-shirt by flurdy (UK)" vspace="5" hspace="5"/></a>
				<br />
			<a href="http://flurdy.spreadshirt.net/en/GB/Shop/Article/Index/article/wrong-evolution-7434008">Somewhere, something went terribly wrong</a>
	</div>

	<a name="config-adv"></a>
	<h3>Advanced mail server</h3>
	<p>
		Now lets extend this setup with more useful content checks
		, security and user interfaces.
	</p>


	<a name="config-adv-content"></a>
	<h4>Content Checks (Anti spam &amp; anti virus)</h4>
	<a name="config-adv-amavis"></a>
	<h5>Amavisd-new</h5>
	<p>
		Amavisd ties together all the different ways of checking email content
		for spam and viruses.
	</p>

	<p>Install amavids-new</p>
	<p>
		<code>sudo apt-get install amavisd-new</code>
	</p>
	<p>
		The defaults are pretty good and also the <a href="https://help.ubuntu.com/community/PostfixAmavisNew">ubuntu documentation</a> is pretty clear, and recommended.
	</p>

	<p>
		Here is a tweaked version of it:<br />
	</p>
	<p>
		Initially we will not enable spam or virus detection!
		This is so we can get amavis set up to receive, check and pass on
		emails before we go on and over-complicate it.
	</p>
	<p>
		All of amavis' configuration files are in <i>/etc/amavisd</i>.
		They are now spread across several files in <i>conf.d</i>.
		Debian and Ubuntu defaults are now very sensible and spread into
		seperate files.
		<code>cd /etc/amavis/conf.d</code>
	</p>
	<p>
		<b><i>01-debian</i></b> defaults are fine.<br />
	</p>
	<p>
		Have a look at <code>less 05-domain_id</code> but dont change anything in it.
	</p>
	<p>
		Have a look at <code>less 05-node_id</code> but dont change anything in it.
	</p>
	<p>
		Have a look at <code>less 15-av_scanners</code> but dont change anything in it.
	</p>
	<p>
		Edit content check file
		<code>sudo vi 15-content_filter_mode</code>
		Comment out both virus and spam scans. (Default).
		<code class="document"><span class="comment"># #@bypass_virus_checks_maps = (
#   \%bypass_virus_checks, \@bypass_virus_checks_acl, \$bypass_virus_checks_re);
# @bypass_spam_checks_maps = (
#   \%bypass_spam_checks, \@bypass_spam_checks_acl, \$bypass_spam_checks_re);</span></code>
	</p>
	<p>
		Have a look at <code>less 20-debian_defaults</code> and <code>less 21-ubuntu_defaults</code> but dont change anything in them.
	</p>
	<p>
		<b><i>25-amavis_helpers</i></b> defaults are fine.<br />
	</p>
	<p>
		<b><i>30-template-localization</i></b> defaults are fine.<br />
	</p>
	<p>
		Edit user file
		<code>sudo vi 50-user</code>
		In the middle insert:
		<code class="document">@local_domains_acl = qw(.);
$log_level = 2;
$syslog_priority = 'debug';
<span class="comment"># $sa_tag_level_deflt = 2.0; # add spam info headers if at, or above that level</span>
<span class="comment"># $sa_tag2_level_deflt = 6.31; # add 'spam detected' headers at that level</span>
$sa_kill_level_deflt = 8.0; <span class="comment"># triggers spam evasive actions</span>
<span class="comment"># $sa_dsn_cutoff_level = 10; # spam level beyond which a DSN is not sent</span>
$final_spam_destiny = D_PASS;
<span class="comment"># $final_spam_destiny = D_REJECT; # default </span>
<span class="comment"># $final_spam_destiny = D_BOUNCE; # debian default </span>
<span class="comment"># $final_spam_destiny = D_DISCARD; # ubuntu default, recommended as sender is usually faked</span></code>
	</p>


	<p>
		We have now setup amavis to scan and pass along incomming email.
		Next we will setup postfix to talk to amavis.
	</p>

	<p>
		<code>sudo vi /etc/postfix/master.cf</code>

		Append these lines to the end of the file
		(make sure they are not already present).
		(Note the -o lines have spaces in front of them.
		<code class="document">amavis      unix    -       -       -       -       2       smtp
        -o smtp_data_done_timeout=1200
        -o smtp_send_xforward_command=yes
        -o disable_dns_lookups=yes
        -o max_use=20</code>
      <code class="document">127.0.0.1:10025 inet    n       -       -       -       -       smtpd
        -o content_filter=
        -o local_recipient_maps=
        -o relay_recipient_maps=
        -o smtpd_restriction_classes=
        -o smtpd_delay_reject=no
        -o smtpd_client_restrictions=permit_mynetworks,reject
        -o smtpd_helo_restrictions=
        -o smtpd_sender_restrictions=
        -o smtpd_recipient_restrictions=permit_mynetworks,reject
        -o smtpd_data_restrictions=reject_unauth_pipelining
        -o smtpd_end_of_data_restrictions=
        -o mynetworks=127.0.0.0/8
        -o smtpd_error_sleep_time=0
        -o smtpd_soft_error_limit=1001
        -o smtpd_hard_error_limit=1000
        -o smtpd_client_connection_count_limit=0
        -o smtpd_client_connection_rate_limit=0
        -o receive_override_options=no_header_body_checks,no_unknown_recipient_checks</code>

		Also add the following two lines immediately below the "pickup" transport service:

        <code class="document"> -o content_filter=
        -o receive_override_options=no_header_body_checks</code>
	</p>
	<p>
		and then  added to main.cf
		<code class="document">sudo vi /etc/postfix/main.cf</code>
		<code class="document">content_filter = amavis:[127.0.0.1]:10024</code>
	</p>

	<p>
		This should be it to get amavis working.
		If emails are picked up by amavis and
		passed back to postfix then it looks okay.
		Only when finished testing do you proced to uncomment the anti virus and anti spam lines
		in
		<code>sudo vi 15-content_filter_mode</code>
		<code class="document">@bypass_virus_checks_maps = (
   \%bypass_virus_checks, \@bypass_virus_checks_acl, \$bypass_virus_checks_re);</code>
		<code class="document">@bypass_spam_checks_maps = (
   \%bypass_spam_checks, \@bypass_spam_checks_acl, \$bypass_spam_checks_re);</code>
		But do that after the next section (SpamAssassin).
	</p>
	<p>
		When things are working we will turn down logging level,
		and start bouncing/discarding spam.
		<code>sudo vi /etc/amavis/conf.d/50-user</code>
		<code class="document">@local_domains_acl = qw(.);
$log_level = 1;
$syslog_priority = 'info';
<span class="comment"># $sa_tag_level_deflt = 2.0; # add spam info headers if at, or above that level</span>
<span class="comment"># $sa_tag2_level_deflt = 6.31; # add 'spam detected' headers at that level</span>
$sa_kill_level_deflt = 8.0; <span class="comment"># triggers spam evasive actions</span>
<span class="comment"># $sa_dsn_cutoff_level = 10; # spam level beyond which a DSN is not sent</span>
<span class="comment"># $final_spam_destiny = D_PASS;</span>
<span class="comment"># $final_spam_destiny = D_REJECT; # default </span>
<span class="comment"># $final_spam_destiny = D_BOUNCE; # debian default </span>
$final_spam_destiny = D_DISCARD; <span class="comment"># ubuntu default, recommended as sender is usually faked</span></code>

	</p>
	<h6><a href="#top">Return to top</a>.</h6>

	<a name="config-adv-spam"></a>
	<h4>Anti-Spam</h4>
	<h5>SpamAssassin</h5>
	<p>Installation:</p>
	<p>
		<code>sudo apt-get install spamassassin spamc</code>
	</p>
	<p>
		The default config of spam assassin is okay.
		You could refer to <a href="edition5.html#spam">previous edition</a>
		for more configuration options.
	</p>
	<p>
		You do need to tell SpamAssassin to start <i>smapd</i> on boot.
		<code>sudo vi /etc/default/spamassassin</code>
		<code class="document">ENABLED=1</code>
	</p>
	<p>
		One configuration option you could tweak is to enable Bayes and auto learning.
		<code>sudo vi /etc/spamassassin/local.cf</code>
	</p>

	<div class="tees">
			<a href="http://flurdy.spreadshirt.net/en/GB/Shop/Article/Index/article/I-read-your-email-7705385"><img
				style="border: 1px solid black;"
				src="http://image.spreadshirt.net/image-server/image/product/8889252/view/1/type/png/width/190/height/190"
				width="120" height="120" border="0" alt="I read your email"
				align="right" title="t-shirt by flurdy (UK)" vspace="5" hspace="5"/></a>
				<br />
			<a href="http://flurdy.spreadshirt.net/en/GB/Shop/Article/Index/article/I-read-your-email-7705385">I read your email</a>
	</div>
	<h6><a href="#top">Return to top</a>.</h6>
	<br />

	<a name="config-adv-virus"></a>
	<h4>Anti Virus</h4>
	<h5>ClamAV</h5>
	<p>Installation:</p>
	<p>
		<code>sudo apt-get install clamav clamav-base libclamav6 clamav-daemon clamav-freshclam</code>
		(Earlier vesions of Ubuntu may use libclamav5)
	</p>
	<p>
		ClamAV does not need setting up.
		Configuration files are in <b><i>/etc/clamav</i></b>,
		but they are automatically generated, so do not edit.
	</p>
	<p>
		By default <b><i>freshclam</i></b>, the daemon that
		updates the virus definition database, is run 24 times a day.
		That seems a little excessive, so I tend to set that to once a day.
		<code>sudo dpkg-reconfigure clamav-freshclam</code>
		It will also ask if you want it to be daemon (yes) and which server is closest to you.
	</p>
	<p>
		If needed, the command below will redefine the configuration with a lot of questions.
		Not needed unless you need to configure.
		<code>sudo dpkg-reconfigure clamav-base</code>
	</p>

	<p>
		Enable scanning by ClamAV of amavis' temporary files.
		<code>sudo adduser clamav amavis</code>
	</p>

	<h6><a href="#top">Return to top</a>.</h6>



	<a name="config-adv-policy"></a>
	<h4>Postgrey</h4>
	<p>Installation:</p>
	<p><code>sudo apt-get install postgrey</code></p>
	<p>
		The default config of postgrey is okay.
		However you need to tell Postfix to use it.
		<code>sudo vi /etc/postfix/main.cf</code>
		And then edit the recipient restrictions:
		<code>smtpd_recipient_restrictions = reject_unauth_pipelining, permit_mynetworks, permit_sasl_authenticated,
		reject_non_fqdn_recipient, reject_unknown_recipient_domain, reject_unauth_destination,
		check_policy_service inet:127.0.0.1:10023, permit</code>
	</p>
	<p>
		You can tweak whitelisting in <b><i>/etc/postgrey</i></b>.
		You can tweak postgrey configuration by tweaking <b><i>/etc/default/postgrey</i></b>.
		E.g. delay, auto whitelisting, or reject message.
	<code>POSTGREY_OPTS="--inet=10023 --max-age=365"</code>
	</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<div class="note">
	<p>
		You know have an advanced mail server.
		You can use this, but Id recommend continuing.
		However this is a good point to <a href="#test">test</a> the set up so far
		and to insert some <a href="#data">data</a> in the db.
	</p>
	</div>

<!--
	<div class="note">
	<p>
		Ive created an EC2 bundle for this stage:
		<a href="#ec2_ami">flurdy-amis/ubuntu-mail-server-spam</a>.
	</p>
	</div>
-->

</div>
<h6><a href="#top">Return to top</a>.</h6>




<br />
<br />

<div class="section">

	<div class="tees">
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/kill-bill-3494310"><img
				src="http://image.spreadshirt.com/image-server/image/product/4169063/view/1/type/png/width/190/height/190"
				alt="no, i will not fix your computer"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/4169063/view/1/type/png/width/190/height/190'"
				onmouseover="this.src='http://image.spreadshirt.net/image-server/image/design/6363926/type/png/width/190/height/190'"
				title="t-shirt by flurdy (US)" vspace="5" hspace="5"/></a>
				<br />
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/kill-bill-3494310">No, I will not fix your computer</a>
	</div>

	<a name="config-secure"></a>
	<h4>Secure mail server</h4>
	<p>
		Stopping hackers, phishers, spammers, your boss and your neighbour from
		accessing your server or the traffic in between is important,
		and easily done.
	</p>

	<a name="config-secure-auth"></a>
	<a name="config-secure-sasl"></a>
	<h3>Authentication</h3>
	<p>
		Normal email traffic between clients and servers are in open plain text.
		That includes passwords and content of emails.
	</p>
	<h5>SASL</h5>
	<p>
		SASL secures the actual authentication (login),
		by encoding the passwords so that it can not be easily intercepted.
		The rest of the emails are however in clear plain text.
	</p>
	<p>
		SASL can be a royal pain to set up,
		especially as it does not support storing encrypted passwords by default in Ubuntu.
		<br/>
		Therefore my <a href="edition5.html#conf_auth">previous</a> editions described how to
		configure SASL using plain text passwords in the database.
	</p>
	<p>
		Obviously this is not ideal, so there are ways to combine SASL and storing encrypted passwords.
		In the future the packages that comes with Ubuntu may support the
		<a href="http://ubuntuforums.org/showthread.php?t=259862">password_format</a>
		configuration option for SASL.
		But until then you can configure SASL to ask PAM to compare the passwords:
	</p>
	<h6>Installation</h6>
	<p><code>sudo apt-get install libsasl2-modules libsasl2-modules-sql libgsasl7\
				libauthen-sasl-cyrus-perl sasl2-bin libpam-mysql</code></p>

	<h6>Configuration</h6>

	<p>
		Enable postfix to access SASL files:
	</p>
	<code>sudo adduser postfix sasl</code>

	<p>
		Create sasl files accessibly even by chrooted Postfix:
	</p>
	<code>sudo mkdir -p /var/spool/postfix/var/run/saslauthd</code>

	<p>
		Add SASL configurations to Postfix:
	</p>
	<code>sudo vi /etc/postfix/main.cf</code>
	<code class="document"><span class="comment"># SASL</span>
smtpd_sasl_auth_enable = yes
<span class="comment"># If your potential clients use Outlook Express or other older clients
# this needs to be set to <i>yes</i></span>
broken_sasl_auth_clients = no
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain =</code>
	<p>Modify these existing configurations:</p>
	<code class="document"><span class="comment"># Add <i>permit_sasl_authenticated</i> to you existing <i> smtpd_sender_restrictions</i></span>
smtpd_sender_restrictions = permit_sasl_authenticated, permit_mynetworks,
		warn_if_reject reject_non_fqdn_sender, reject_unknown_sender_domain,
		reject_unauth_pipelining, permit
<span class="comment"># Add <i>permit_sasl_authenticated</i> to you existing <i> smtpd_recipient_restrictions</i></span>
smtpd_recipient_restrictions = reject_unauth_pipelining, permit_mynetworks,
		permit_sasl_authenticated, reject_non_fqdn_recipient, reject_unknown_recipient_domain,
		reject_unauth_destination, check_policy_service inet:127.0.0.1:10023, permit</code>

	<p>
		Change how SASLAUTHD is run:
	</p>
	<code>sudo vi /etc/default/saslauthd</code>
	<code class="document"><span class="comment"># Toggle this to <i>yes</i></span>
START=yes
<span class="comment"># Switch this to be under postfix's spool</span>
<span class="comment"># And add <i>-r</i> so that the realm(domain) is part of the username</span>
OPTIONS="-r -c -m /var/spool/postfix/var/run/saslauthd"</code>

	<p>
		Tell postfix how to interact with SASL:
	</p>
	<code>sudo vi /etc/postfix/sasl/smtpd.conf</code>
	<code class="document">pwcheck_method: saslauthd
mech_list: plain login cram-md5 digest-md5
log_level: 7
allow_plaintext: true
auxprop_plugin: sql
sql_engine: mysql
sql_hostnames: 127.0.0.1
sql_user: mail
sql_passwd: <i>mailPASSWORD</i>
sql_database: maildb
sql_select: select crypt from users where id='%u@%r' and enabled = 1</code>
	<p>
		(When SASL is working you can remove the <i>log_level</i> line.)
	<br/>
		(<em>Note</em>: While <em>sql_passw</em> is the original parameter name (without the <em>d</em>), a more obvious <em>sql_passwd</em> will also work in later versions)</p>

	<p>
		Tell the pam how to to authenticate smtp via mysql:
	</p>
	<code>sudo vi /etc/pam.d/smtp</code>
	<p>These must be on 2 lines only, but I have broken them up for easier to read.</p>
	<code>auth required pam_mysql.so user=mail passwd=<i>aPASSWORD</i>
			host=127.0.0.1 db=maildb table=users usercolumn=id passwdcolumn=crypt crypt=1
account sufficient pam_mysql.so user=mail passwd=<i>aPASSWORD</i>
			host=127.0.0.1 db=maildb table=users usercolumn=id passwdcolumn=crypt crypt=1</code>

	<p>
		In addition to tailing <i>var/log/mail.log</i> and <i>/var/log/mysql/mysql.log</i>
		it is quite usefull to tail the auth.log as well when testing SASL.
	</p>
	<code>tail -f /var/log/auth.log</code>

	<p>
		Restart postfix and saslauthd to enable SASL for sending emails.
	</p>
	<code>sudo /etc/init.d/saslauthd restart
sudo /etc/init.d/postfix restart</code>

	<h5>Imap SASL / Courier</h5>
	<p>
		I tend not to have SASL for my courier authentication,
		as I enforce TLS for all my clients. <br/>
		However if you have a more lenient access policy which is wise if you have many users,
		then you may want SASL in Courier as well:
	</p>
	<p>
	</p>
	<code>sudo vi /etc/courier/imapd</code>
	<p>
		This may already be avaiable as a commented out line.
		If not replace the current line by adding UTH=CRAM-MD5 AUTH=CRAM-SHA1 so it resembles something like this:
		(Again on one line)
	</p>
	<code>IMAP_CAPABILITY="IMAP4rev1 UIDPLUS CHILDREN NAMESPACE
			THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT QUOTA AUTH=CRAM-MD5 AUTH=CRAM-SHA1 IDLE"</code>
	<code>sudo /etc/init.d/courier-authdaemon restart;
sudo /etc/init.d/courier-imap restart</code>

	<h6><a href="#top">Return to top</a>.</h6>
	<br/>
	<br/>

	<a name="config-secure-tsl"></a>
	<a name="config-secure-crypt"></a>
	<h3>Encryption</h3>
	<h5>TLS</h5>
	<p>
		Encrypting the traffic stops anyone else listening in on your email communications.
		And is very recommended. There are different types of communication to encrypt:
		The data traffic between your email applications and the server when you read emails
		or when you send emails,
		and communication between other email servers and your server.
	</p>
	<p>
		For the encryption of reading emails, it is Courier you need to configure.
		For sending, and beetwen server encryption it is Postfix.
	</p>
	<h5>TLS in Postfix</h5>
	<p>
		To encrypt you need certificates. Ubuntu creates some for you for which you can use
		while setting up the server. However before you go live,
		it is recommended to create your own with your proper domain name etc.
		Please refer to <a href="edition5.html#conf_tls">previous edition</a>
		for more detail.
	</p>
	<p>
		<code>vi /etc/postfix/main.cf</code>
		There are already some TLS settings in the default debian/ubuntu version of this file.
		I moved these to the end, for clarity, but that is up to you.
		<code># TLS parameters
<span class="comment"># smtp_use_tls = no</span>
smtp_tls_security_level = may
<span class="comment"># smtpd_use_tls=yes</span>
smtpd_tls_security_level = may
<span class="comment"># smtpd_tls_auth_only = no</span>
smtp_tls_note_starttls_offer = yes
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes
smtpd_tls_session_cache_timeout = 3600s
tls_random_source = dev:/dev/urandom
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
<span class="comment"># smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
# smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache</span>
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt</code>
	</p>
	<p>
		Next we have a look at the master.cf file.
		<code>vi /etc/postfix/master.cf</code>
		By default only the normal smtp service is enabled,
		which is fine.
		But I prefer to enable <i>submission</i> (port 587),
		so that clients can use it, and I can restrict them to TLS only.
		Also enabled <i>smtps</i> service (port 465),
		for some compatebility with some older clients (outlook express etc).
	</p>
	<code>submission inet n       -       n       -       -       smtpd
  -o smtpd_sasl_auth_enable=yes
<span class="comment"># if you do not want to restrict it encryption only, comment out next line</span><
  -o smtpd_tls_auth_only=yes
<span class="comment"># -o smtpd_tls_security_level=encrypt
#  -o header_checks=
#  -o body_checks=</span><
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject_unauth_destination,reject
  -o smtpd_sasl_security_options=noanonymous,noplaintext
  -o smtpd_sasl_tls_security_options=noanonymous
<span class="comment"># -o milter_macro_daemon_name=ORIGINATING</span><
smtps     inet  n       -       -       -       -       smtpd
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_tls_auth_only=yes
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o smtpd_sasl_security_options=noanonymous,noplaintext
  -o smtpd_sasl_tls_security_options=noanonymous
<span class="comment">#  -o milter_macro_daemon_name=ORIGINATING</span></code>
	<h5>TLS in Courier</h5>
	<p>
		Again Ubuntu has created a certificate for you, but if you want to create your own,
		especially for a properly named server, then do this.
		<code>cd /etc/courier
openssl req -x509 -newkey rsa:1024 -keyout imapd.pem \
  -out imapd.pem -nodes -days 999</code>
  		For more details <a href="edition5.html#conf_encryption">review an earlier edition</a>.
	</p>
	<p>
		Then you need to edit
		<code>vi /etc/courier/imapd-ssl</code>
		By default Ubuntu already points to you certificate
		<code>TLS_CERTFILE=/etc/courier/imapd.pem</code>
		Modify this if needed.
	</p>
	<p>
		Also you if want to restrict IMAP users to SSL/TLS only toggle this setting to 1.
		<code>IMAP_TLS_REQUIRED=1</code>
	</p>

<br />
<br />

	<p>
		For maximum compatibility it is not wise to restrict to TLS only for the traffic between servers. As this means not all valid emails sent by others can reach your server.
		However enabling them the option to encrypt is a good idea.
	</p>
	<p>
		Be aware that the emails are not encrypted on your machine, nor on the server.
		For this type of client encryption, please refer to <a href="edition5.html#app">previous edition</a>
		for more on GnuPG.
	</p>
	<p>
		In some situations SASL and TLS do not play well together.
		Those situations are in combinations of storing encrypted passwords,
		using MD5 authentication over encrypted traffic.
		I recommend, insisting on TLS traffic with your authenticating clients,
		which then negates the need for SASL.
	</p>


	<h5>HTTPS</h5>

	<p>
		You probably also want to insist on https connections over tls if you below add webmail that are exposed to the public.
		Securing a web server is out of scope for this howto, but will not be a lot different than the mail server tls settings.
	</p>

	<div class="note">
	<p>
		You know have an advanced secure mail server.
		Now is another good point to <a href="#test">test</a> the set up so far
		and to insert some <a href="#data">data</a> in the db.
	</p>
	</div>

<!--
	<div class="note">
	<p>
		Ive created an EC2 bundle for this stage:
		<a href="#ec2_ami">flurdy-amis/ubuntu-mail-server-secure</a>.
	</p>
	</div>
-->

</div>
<h6><a href="#top">Return to top</a>.</h6>
<br />
<br />

<div class="section">

	<a name="config-extra-webmail"></a>
	<h3>Webmail</h3>

	<h5>Enable web access</h5>
	<p>
		You may need to enable web access in the firewall.
		Check the <a href="#conf-simple-firewall">firewall configuration</a> if this necessary.
	</p>
	<h4>Alternative: SquirrelMail</h4>
	<p>
		This howto in previous <a href="#editions">editions</a> used to have <a href="http://www.squirrelmail.org">SquirrelMail</a> as the webmail client. It is more mature with a longer testing record. It has a large library of various plugins.
		Please read the <a href="#ext_squirrel">SquirrelMail extension</a> further down on how to install it instead if preferred.
	</p>

	<a name="ext_round"></a>
	<h4>Roundcube webmail client</h4>
	<p>To install Roundcube</p>
	<code>sudo apt-get install roundcube roundcube-mysql roundcube-plugins</code>
	<p>
		It will ask you if you want to configure its database access,
		answer yes, then select mysql.
		Then it will ask for the root mysql uses password,
		which it will create a roundcube mysql user and ask for its desired password.
	</p>
	<p>
		This will create a symblink in <i>/etc/apache2/conf.d/</i>
		to <i>/etc/roundcube/apache.conf</i>.
		Edit this file.
	</p>
	<code>sudo vi /etc/roundcube/apache.conf</code>
	<p>
		Depending on your setup you may want to move those <i>Alias</i>
		commands at the top to your virtual hosts configuration,
		or for this example enable them here for all hosts.
	</p>
	<code class="document"><span class="comment"># Uncomment them to use it or adapt them to your configuration</span>
Alias /roundcube/program/js/tiny_mce/ /usr/share/tinymce/www/
Alias /roundcube /var/lib/roundcube</code>

	<p>Next edit the configuration file</p>
	<code>sudo vi /etc/roundcube/main.inc.php</code>
	<p>Modify these lines for added security and ease of log in:</p>
	<code class="document">$rcmail_config['default_host'] = 'ssl://localhost';

$rcmail_config['default_port'] = '993';

$rcmail_config['imap_force_ns'] = true;

$rcmail_config['smtp_server'] = 'ssl://localhost';

$rcmail_config['smtp_port'] = 465;

<span class="comment"># keep as default or change to your mail server name</span>
$rcmail_config['smtp_helo_host'] = '<i>mail.example.com</i>';

$rcmail_config['create_default_folders'] = TRUE;</code>
	<p>There are other tweaks and security features you can enable such as:</p>
	<code class="document">$rcmail_config['sendmail_delay'] = 1;</code>
	<p>But perhaps concentrate on getting the basics working firtst...</p>

	<p>Save, exit and reload Apache to enable these aliases for Roundcube to work</p>
	<code>sudo /etc/init.d/apache2 reload</code>
	<p>
		Then go to your roundcube installation depending where and how
		you modified those Aliases, e.g. at
		<i>http://mail.example.com/roundcube</i>.<br/>
		That should be it
	</p>

	<p>If you have enabled session encryption then also enable the <i>mcrypt</i> library</p>

	<code>sudo ln -s /etc/php5/mods-available/mcrypt.ini /etc/php5/apache2/conf.d/20-mcrypt.ini</code>

	<p>
		You can obviously modify and tweak further.
	</p>
	
	<ul>
		<li>
			<p>
				One thing that may be useful is to have
				the Roundcube Apache <i>Alias</i> on different virtual hosts.
			</p>
		</li>
		<li>
			<p>
				Other is to configure <i>username_domain</i> in <i>main.inc.php</i>
		to append different email addresses
			</p>
		</li>
		<li>
			<p>
				Or configure the <i>default_host</i> to
				different mail server depending on virtual host
			</p>
		</li>
		<li>
			<p>
				For security enforcing https for the webmail is probably smart.
			</p>
		</li>
		<li>
			<p>
				Adding your own skin logo etc to customise the look is likely.
				<i>( $rcmail_config['skin_logo'] = 'yourlogo.png'; )</i>
			</p>
		</li>
		<li>
			<p>
				If you webmail is not on the same server as your MTA (Postfix),
				then the MTA might not have the webmail server's IP listed in permit_mynetworks,
				so you might want to log into the smtp when sending email:
<code>$rcmail_config['smtp_user'] = '%u';
$rcmail_config['smtp_pass'] = '%p';
$rcmail_config['smtp_auth_type'] = 'login';
</code>
			</p>
		</li>
		<li>
			<p>
			</p>
		</li>
	</ul>
	<p>
		
		 
		
		
	</p>
	<p>
		More details on the <a href="http://trac.roundcube.net/wiki/">Roundcube Wiki</a>.
	</p>
<h6><a href="#top">Return to top</a>.</h6>



	<a name="config-extra-admin"></a>
	<h3>Administration</h3>

	<h5>Enable web access</h5>
	<p>
		You may need to enable web access in the firewall.
		Check the <a href="#conf_firewall">firewall configuration</a> if this neccessary.
	</p>
	<h5>Install phpmyadmin</h5>
	<code>sudo apt-get install phpmyadmin</code>
	<p>
		Enter <i>Yes</i> to set it up, enter root mysql password, enter a phpmyadmin mysql user password twice.
		Accept apache2 as the web server.
	</p>
	<!--
	<p>
		You used to have to copy a phpMyAdmin configuration to apache,
		however it is now symlinked from <i>/etc/apache2/conf.d/</i>,
		so you do not need to do the next couple of steps.
		<code><s>sudo cp /etc/phpmyadmin/apache.conf /etc/apache2/sites-available/phpmyadmin</s></code>
		And enable with this
		as Florent recommends:
		<code><s>sudo a2ensite phpmyadmin</s></code>
	</p>
	-->
	<p>
		You may choose to restrict phpMyAdmin to a spefic virtual host.
		If so you need to, edit
		<code>sudo vi /etc/apache2/conf.d/phpmyadmin.conf</code>
		and comment out the alias.
		<code class="document"><span class="comment">#Alias /phpmyadmin /usr/share/phpmyadmin</span></code>
		And insert the alias instead into a virtual host configuration in <i>/etc/apache2/sites-available/</i>.
		For this example we are not, and for testing we keep the <i>Alias</i> uncommented.
	</p>
	<p>
		Reload apache to activate changes.
		First test if ok.
		<code>sudo apache2ctl -t</code>
		Then reload it.
		<code>sudo /etc/init.d/apache2 reload</code>
	</p>
	<p>
		You can now go to <b><i>http://yourdomain.com/phpmyadmin/</i></b>,
		and login with the <b><i>mail</i></b> user.
		You can use it as it is, but I recommend securing it a bit more.
	</p>
	<p>
		One simple way is adding apache's .htaccess login requirement.
	</p>
	<p>
		Further restrictions can be restricting to a specific virtual host.
		Or renaming the folder. Purely ubfuscating, but simple.
	</p>
	<p>
		Or using the example in the webmail section,
		and adding SSL requirement to the connection.
		Or disabel mysql root's access via phpMyAdmin.
	</p>
	<p>
		Please refer to <a href="edition5.html#conf_admin">previous edition</a>
		for example on htaccess, and mysql user restriction.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="config-external"></a>
	<a name="config-external-domain"></a>
	<a name="config-external-dns"></a>
	<h3>External changes</h3>
	<p>
		Before making any changes you need to have done a few steps externally.
		(Or at least before you start testing).
	</p>

	<h4>Domain name</h4>
	<p>
		You need a <a href="http://en.wikipedia.org/wiki/Domain_name">domain name</a> to use with your email server.
		This may be one you purchased, or a subdomain of an existing one,
		or a dynamic one e.g. <a href="http://dyndns.org">dyndns.org</a>.
	</p>

	<h4>DNS</h4>
	<p>
		You will also need to configure the MX details for the <a href="http://en.wikipedia.org/wiki/Domain_Name_System">DNS</a> of this server.
		<!-- Refer to a <a href="edition5.html#conf_dns">previous edition</a>.  -->
		This is done via your domain registrar, or sometimes an external nameserver(DNS) provider.
		You can also host your own DNS via packages such as <a href="http://www.isc.org/software/bind">Bind</a>.
	</p>
	<p>
		Your provider might let you do this through a GUI, but in this is technically how a the configuration should look like:
	</p>
	<code><i>domain.tld</i>&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;&nbsp;&nbsp;MX&nbsp;&nbsp;&nbsp;10&nbsp;&nbsp;&nbsp;<i>yourmailserver.domain.tld</i></code>
	<p>
		(Replace <i>domain.tld</i> with your domain name, and <i>yourmailserver.domain.tld</i> with the full name of your mail server).
		Repeat this for each domain that you want the server to handle.
	</p>
	<p>
		Further mx entries are possible in the same file, if there are subdomains. And also if you have <a href="http://en.wikipedia.org/wiki/MX_record#The_backup_MX">backup MX</a> servers. Refer to <a href="#ext_mx">my backup MX section</a> if interested.
	</p>
	<p>
		Note: Some other mail systems will check via <a href="http://en.wikipedia.org/wiki/Reverse_DNS_lookup">reverse DNS</a>
		for a match between IP and mail server name, as part of their spam scoring.
	</p>
	<p>
		If people need suggestions for domain registrars or dns providers then <a href="#contact">let me know</a>
	</p>
	<br/>



	<div class="note">
	<p>
		You know have a finished mail server.
		This is as far as the main guide goes.
		Hope it was clear enough to follow.
	</p>
	<p>
		Now it is time to insert <a href="#data">data</a>,
		and to <a href="#test">test</a> how it works.
	</p>
	<p>
		Feel free to <a href="#extend">extend it</a> with my suggestions further down.
	</p>
	</div>

<!--
	<div class="note">
	<p>
		Ive created an EC2 bundle for this stage:
		<a href="#ec2_ami">flurdy-amis/ubuntu-mail-server-webmail</a>.
	</p>
	</div>
-->

<script type="text/javascript"><!--
google_ad_client = "pub-7805345644641760";
/* postfix ed7 leader 1 */
google_ad_slot = "9399087443";
google_ad_width = 728;
google_ad_height = 90;
//-->
</script>
<script type="text/javascript"
src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
</script>

</div>
<h6><a href="#top">Return to top</a>.</h6>





<a name="data"></a>
<h2>Data</h2>
<div class="section">

	<ul>
		<li><p><a href="#data_add">Add users and domains</a></p>
			<ul>
				<li><p>Required domains and users</p></li>
				<li><p>Example domains and users</p></li>
				<li><p>Adding template</p></li>
			</ul>
		</li>
		<li><p><a href="#data_common">Common SQL</a></p></li>
	</ul>

		<a name="data_add"></a>
		<h3>Add users and domains</h3>
			<p>
				So we got a fully set up mail server...
				Well no, there is no users, domains, no nothing!
			</p>
			<p>
				Okay, first you need add some default data,
				some which are required, some which make sense.
			</p>
			<p>
				Then we'll add your own users and domains.
			</p>

		<h4>Required domains and users</h4>

		<p>First the required domains for local mail</p>

		<code><span class="comment"># Use phpMyAdmin or command line mysql</span>
INSERT INTO domains (domain) VALUES
	('localhost'),
	('localhost.localdomain');</code>

		<p>
			Then some default aliases.
			Some people say these are not needed, but I'd include them.
		</p>

		<code>INSERT INTO aliases (mail,destination) VALUES
	('postmaster@localhost','root@localhost'),
	('sysadmin@localhost','root@localhost'),
	('webmaster@localhost','root@localhost'),
	('abuse@localhost','root@localhost'),
	('root@localhost','root@localhost'),
	('@localhost','root@localhost'),
	('@localhost.localdomain','@localhost');</code>

		<p>Then a root user.</p>

		<code>INSERT INTO users (id,name,maildir,crypt) VALUES
	('root@localhost','root','root/',encrypt('<i>apassword</i>', CONCAT('$5$', MD5(RAND()))) );</code>

		<p>
			Note: this uses the encrypt function with a <a href="https://en.wikipedia.org/wiki/Salt_%28cryptography%29">random salt</a> per user and prefixed with <a href="http://manpages.courier-mta.org/htmlman3/crypt.3.html">$5$</a> which instructs it to use <a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256</a> encryption hashing.
		</p>
		<p>
			You can alternatively use the plain encrypt('apassword') function,
			however it is then unsalted and only considers the first 8 character of the password.
			<br/>
			This may be required if you use other software that
			needs to interact with the users authentication.
			However most will support the SHA-256 crypt() call.
		</p>

	<div class="tees">
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/I-see-dumb-people-3764115"><img
				src="http://image.spreadshirt.com/image-server/image/product/4136811/view/1/type/png/width/190/height/190"
				alt="I see dumb people"
				onmouseover="this.src='http://image.spreadshirt.com/image-server/image/design/769535/type/png/width/190/height/190'"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/4136811/view/1/type/png/width/190/height/190'"
				align="right" title="t-shirt by flurdy (UK)" vspace="5" hspace="5"/></a>
	</div>

		<h4>Domains and users</h4>
		<p>
			Now lets add some proper data.
		</p>
		<p>
			Say you want this machine to handle data for the fictional domains
			of <i>"blobber.org"</i>, <i>"whopper.nu"</i> and <i>"lala.com"</i>.
		</p>
		<p>
			Then say this machine's name is <i>"mail.blobber.org"</i>.
		</p>
		<p>
			All email to <i>lala.com</i> is to be forwarded to <i>whupper.nu</i>.
		</p>
		<code>INSERT INTO domains (domain) VALUES
	('blobber.org'),
	('mail.blobber.org'),
	('whopper.nu'),
	('lala.com');

INSERT INTO aliases (mail,destination) VALUES
	('@lala.com','@whupper.nu'),
	('@mail.blobber.org','@blobber.org'),
	('postmaster@whopper.nu','postmaster@localhost'),
	('abuse@whopper.nu','abuse@localhost'),
	('postmaster@blobber.org','postmaster@localhost'),
	('abuse@blobber.org','abuse@localhost');</code>

		<p>
			You also have two users called <i>"Xandros"</i> and <i>"Vivita"</i>.
		</p>
		<code>INSERT INTO users (id,name,maildir,crypt) VALUES
	('xandros@blobber.org','xandros','xandros/',encrypt('<i>apassword</i>', CONCAT('$5$', MD5(RAND()))) ),
	('vivita@blobber.org','vivita','vivita/', encrypt('<i>anotherpassword</i>', CONCAT('$5$', MD5(RAND()))) );

INSERT INTO aliases (mail,destination) VALUES
	('xandros@blobber.org','xandros@blobber.org'),
	('vivita@blobber.org','vivita@blobber.org');</code>

		<p>
			You want all mail for <i>whooper.nu</i> to go to <i>xandros</i> (catchall).
		</p>
		<code>INSERT INTO aliases (mail,destination) VALUES
		('@whopper.nu','xandros@blobber.org');</code>

		<p>
			There is also a <i>"Karl"</i> user, but he does want all mail forwarded
			to an external account.
		</p>
	<code>INSERT INTO aliases (mail,destination) VALUES
	('karl@blobber.org',<i>'karl.vovianda@gmail.com'</i>);</code>

		<p>
			So what does each of these lines actually do?
			Well the domains are pretty straight forward.
		</p>
		<p>
			The users are as well, it requires four fields.
			ID is the email address of the user, and also its username
			when loggin in, described later on.
			NAME is optional description of the user.
			MAILDIR is the name of the folder inside <b>/var/spool/mail/virtual</b>.
			It must end in a /, otherwise it wont be used as a unix maildir format.
			CRYPT is the encrypted text password to use.
		</p>
		<p>
			The alises are the interesting part.
			Lets start from a top down view to see how emails get delivered:
		</p>
		<p>
			Say an email arrives addressed to <i>"john@whopper.nu"</i>.
		<ul>
			<li><p>
				Postfix looks up domains and say <i>whopper.nu</i> is an domain it listens to.
			</p></li>
			<li><p>
				Postfix then looks up aliases and searches for a row where the mail field matches <i>"john@whopper.nu"</i>.
			</p></li>
			<li><p>
				None does so it next searches for <i>"@whopper.nu"</i>,
				which is the way to specify catch all others for that domain.
			</p></li>
			<li><p>
				It finds one row and its destination is <i>"xandros@blobber.org"</i>.
			</p></li>
			<li><p>
				It then searches for <i>"xandros@blobber.org"</i>
				and finds one, which destination is the same as the mail,
				therefore it is the final destination.
			</p></li>
			<li><p>
				It then tries to deliver this mail. The look up says <i>blobber.org</i>
				is a local mail so it looks up users for a matching id and delivers it
				to its maildir.
			</p></li>
		</ul>


		<p>
				Lets try <i>"julian.whippit@lala.com"</i>.
		</p>
		<ul>
			<li><p>
				Postfix looks up domains and it is an domain it listens to.
			</p></li>
			<li><p>
				First lookup does not find this user,
				but the next finds the catchall <i>"@lala.com"</i>.
				But its destination is another catchall, <i>"@blobber.org"</i>.
			</p></li>
			<li><p>
				This means Postfix will look for <i>"julian.whippit@blobber.org"</i>.
				This address is not found either, nor is a catchall for <i>blobber.org</i>.
				Therefore this address is not valid and the message will be bounced.
			</p></li>
		</ul>

			<p>
				Any mail arriving for <i>"karl@blobber.org"</i> or <i>"karl@lala.com"</i>,
				gets forward to an external address of <i>"karl.vovianda@gmail.com"</i>.
				So forwarding is simple. I tend to use a subdomain for all my friends
				addresses as easily I forget what their real addresses
				are, and I use different email clients all the time.
			</p>

			<p>
				I also added the required aliases of postmaster and abuse to
				<i>blobber.org</i> and <i>whopper.nu</i>.
				The catchall for <i>lala.com</i> means they are not required for that domain.<br/>
				<!-- You can add them though if you do not want <i>xandros</i>
				to get the admin emails. -->
				Another useful alias to add is <i>root</i>,
				as often you get admin mail from e.g cron jobs within
				those domains etc.
				Other often used aliases are <i>info, sysadmin, support, sales,
				webmaster, mail, contact</i> and <i>all</i>.
				But they are also honeypots for spam,
				so just include the ones you think you will need.
			</p>

		<h4>Adding template</h4>
		<p>
			So to add a new domain to the system, You do this, replacing the italics with relevant data:
		</p>

		<code>INSERT INTO domains (domain) VALUES ('<i>domain.tld</i>');
INSERT INTO aliases (mail,destination) VALUES
	('<i>@domain.tld</i>','<i>email@address</i>'),
	('<i>postmaster@domain.tld</i>','<i>email@address</i>'),
	('<i>abuse@domain.tld</i>','<i>email@address</i>');</code>

		<p>
			And to add a new user to the system, do this:
		</p>

		<code>INSERT INTO users (id,name,maildir,crypt) VALUES
	('<i>email@address</i>','<i>short description</i>','<i>foldername/</i>',encrypt('<i>password</i>', CONCAT('$5$', MD5(RAND()))) );
INSERT INTO aliases (mail,destination) VALUES
	('<i>email@address</i>','<i>email@address</i>');</code>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="data_common"></a>
	<h3>Common SQL</h3>
	<p>
		A selection of useful sql statements, if you are not using an admin/manager program to
		maintain your email domains and users.
	</p>
	<p>Find domains without a catchall</p>
<code><span class="comment">#Remember some might be disabled</span>
SELECT dom.domain
FROM domains dom
LEFT JOIN aliases al
	ON CONCAT( '@', dom.domain ) = al.mail
WHERE al.mail is null
OR al.enabled = 0
ORDER BY dom.domain ASC
</code>
	<h4>Find aliases for an invalid domain</h4>
<code>SELECT al.*
FROM aliases al
LEFT JOIN domains dom
	ON dom.domain = SUBSTRING(al.mail,LOCATE('@',al.mail)+1)
WHERE dom.domain is null
OR dom.enabled = 0
ORDER BY al.mail ASC
</code>
	<h4>Find all non local destination aliases</h4>
<code>SELECT al.*
FROM aliases al
LEFT JOIN domains dom
	ON dom.domain = SUBSTRING(al.destination,LOCATE('@',al.destination)+1)
WHERE dom.domain is null
ORDER BY al.enabled, al.destination ASC, al.mail ASC</code>
	<h4>Find all aliases for a certain domain</h4>
<code>SELECT al.*
FROM aliases al
WHERE SUBSTRING(al.mail,LOCATE('@',al.mail)+1) = 'domain.tld'
ORDER BY al.enabled, al.mail ASC</code>

<h4>Find all aliases for a certain domains, checking if enabled for both domain and alias</h4>
<code>select *
from domains d
join aliases a
  on a.mail like concat( '%','@',d.domain)
  and a.enabled = 1
where d.enabled = 1
and d.domain like '%foobar%'
order by d.domain,a.mail</code>

</div>
<h6><a href="#top">Return to top</a>.</h6>







<a name="test"></a>
<h2>Test</h2>
<div class="section">

	<div style="float: right;">
	<OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab" id="Player_7fee7f3a-aa29-44df-99f6-143c810b134f"  WIDTH="500px" HEIGHT="175px"> <PARAM NAME="movie" VALUE="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fflurdy-20%2F8010%2F7fee7f3a-aa29-44df-99f6-143c810b134f&Operation=GetDisplayTemplate"><PARAM NAME="quality" VALUE="high"><PARAM NAME="bgcolor" VALUE="#FFFFFF"><PARAM NAME="allowscriptaccess" VALUE="always"><embed src="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fflurdy-20%2F8010%2F7fee7f3a-aa29-44df-99f6-143c810b134f&Operation=GetDisplayTemplate" id="Player_7fee7f3a-aa29-44df-99f6-143c810b134f" quality="high" bgcolor="#ffffff" name="Player_7fee7f3a-aa29-44df-99f6-143c810b134f" allowscriptaccess="always"  type="application/x-shockwave-flash" align="middle" height="175px" width="500px"></embed></OBJECT> <NOSCRIPT><A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fflurdy-20%2F8010%2F7fee7f3a-aa29-44df-99f6-143c810b134f&Operation=NoScript">Amazon.com Widgets</A></NOSCRIPT>
	</div>


	<ul>
		<li><p><a href="#test-common">Common problems</a></p></li>
		<li><p><a href="#test-strategy">Test strategy</a></p></li>
		<li><p><a href="#test-tail">Tail, tail and tail again</a></p></li>
		<li><p><a href="#test-services-off">Switch off services</a></p></li>
		<li><p><a href="#test-debug">Switch debug on</a></p></li>
		<li><p><a href="#test-telnet">Telnet is your friend</a></p></li>
		<li><p><a href="#test-postfix-receive">Can postfix receive?</a></p></li>
		<li><p><a href="#test-postfix-send">Can postfix send?</a></p></li>
		<li><p><a href="#test-courier">Can courier read?</a></p></li>
	</ul>

	<a name="test-common"></a>
	<h4>Common problems</h4>
	<ul>
		<li>
			<h5>Missed a step</h5>
			<p>
				If you mistakenly or intentially skipped past sections,
				you may have missed an important step in your configuration,
				which my guide pressumes you have followed.
			</p>
		</li>
		<li>
			<h5>Typo</h5>
			<p>
				99% of all problems is spelling errors or typos you entered
				while following this guide. Sorry, but it just happens.
				Often it can be trivial, such as a <i>space</i> at the end
				of the configuration line which was not expected etc.
				Or not understanding my example where it is a multi line
				entry.
			</p>
		</li>
		<li>
			<h5>Typo by me</h5>
			<p>
				Yes, I make a lot of mistakes. Nothing wrong in that,
				but I hope I have corrected most over time.
				Any new sections are however at risk... :)
			</p>
		</li>
		<li>
			<h5>Different application or configurations</h5>
			<p>
				It is obviously entirely up to you how you set up your system.
				But the more you deviate from this guide,
				the more likely incompatibilties or confusion will arrise.
			</p>
		</li>
		<li>
			<h5>Distrobution/version differences</h5>
			<p>
				If you run a different version or even distrobution to this guide,
				then some things will be different.
				Small issues, such as default values and significant things
				such as path differences etc.
				Some sections in this guide are not always thouroughly
				tested with every new release of Ubuntu,
				but these differences gets <a href="#contact">pointed out by people for me</a>.
			</p>
		</li>
		<li>
			<h5>Walking before crawling</h5>
			<p>
				Don't try the full blown mail server before the basics are working.
			</p>
		</li>
		<li>
			<h5>Gamma rays and little goblins</h5>
			<p>Got to blame it on something or someone.</p>
		</li>
	</ul>
	<h6><a href="#top">Return to top</a>.</h6>

	<br/>

	<a name="test-strategy"></a>
	<h4>Test strategy</h4>

	<p>
		What steps to think of when testing.
	</p>

	<h5>Test early and frequently</h5>
	<p>
		It is very helpfull to test early in this set up,
		to establish if the first sections are working as expected.
	</p>
	<p>
		So when you only have your very basic postfix and mysql up: Test it!<br/>
		That way you know that bit worked and can rule it out of any future problems.<br/>
		Don't wait till you complicated and mudded the water after amavis, courier etc is added.
	</p>
	<p>
		By constantly testing if you can send and receive you can tick off and black box
		each section as working, and immidietly spot issues.
	</p>


	<h5>Isolate the problem</h5>
	<p>
		Testing how things work is often about isolating the problem first.
		So by using the steps of testing  early above, you can see which step caused the problem.
	</p>
	<p>
		Also if you can't log into your webmail it is often nothing to do with the webmail section
		that is causing the problem. Often postfix itself is broken etc.
	</p>


	<h5>Test in order</h5>
	<p>
		As part of the isolating the problem rule,
		you most of the time test in order,
		and test each section thus isolating the problem.
		This would then quickly isolate the problem when e.g. such as above issues of reading emails via the webmail.
		This would be in order:
		<ol>
			<li><p>Access: Can I get(ssh) to the box, and is there a firewall issue?</p></li>
			<li><p>Database: Is the database up, do my application reach it?</p></li>
			<li><p>Postfix: Can I send email by command line, do I receive emails via telnet?</p></li>
			<li><p>Content checks: Do they cause a problem?</p></li>
			<li><p>Courier: Can I read emails?</p></li>
			<li><p>Webmail: And last but not least does the web integration work?</p></li>
		</ol>
	</p>

	<h5>Simplify the system</h5>
	<p>
		Assisting in isolating the problem,
		you often have to disable options and applications.
		Such as turn of postgrey or content checks to make sure emails to get delivered.
	</p>

	<p><a href="edition5.html#test">Previous editions</a> do have some more detail on how to achieve this</p>


	<h6><a href="#top">Return to top</a>.</h6>

	<br/>

	<a name="test-tail"></a>
	<h4>Tail, tail and tail again</h4>
	<p>
		Essential to monitor what actually happens, and tailing specifically the mail and mysql log.
	</p>
	<ul>
		<li><p>/var/log/system.log</p></li>
		<li><p>/var/log/mail.log</p></li>
		<li><p>/var/log/mysql/mysql.log</p></li>
		<li><p>/var/log/apache2/access.log</p></li>
	</ul>
	<p>
		In one window:
		<code>tail -f /var/log/mail.log</code>
		And in another window:
		<code>tail -f /var/log/mysql/mysql.log</code>
		In a third or more do your actual configuration or testing.
	</p>

	<h6><a href="#top">Return to top</a>.</h6>

	<br/>

	<a name="test-services-off"></a>
	<h4>Switch off services</h4>
	<p><i><a href="edition5.html#test">previous edition 1</a></i></p>
	<p><i><a href="edition5.html#test2">previous edition 2</a></i></p>
	<p>
		The previous editions has detail on switching services off until time to test them.
		<br/>
		It also details locking down your server from spammers until finished testing.
	</p>

	<h6><a href="#top">Return to top</a>.</h6>

	<br/>


	<a name="test-debug"></a>
	<h4>Switch debug on</h4>

	<h5>Shorewall</h5>
	<p>
		You can also switch on more messages for when the firewall is rejecting connections.
		Add <i>info</i> to all <i>REJECT</I>, <i>BOUNCE</i> and <i>DROP</i> policies.
		<code>sudo vi /etc/shorewall/policy</code>
		such as:
		<code>net	all	DROP		info</code>
	</p>

	<h5>MySQL</h5>
	<p>
		There is no point in tailing the mysql log if query debugging is not turned one. <br/>
		By default it is not.
		However in this guide I do switch it on,
		in case that was missed switch it on now:
		<code>sudo vi /etc/mysql/my.cnf</code>
		Make sure this is not commented out
		<code>log = /var/log/mysql/mysql.log</code>
	</p>

	<h5>Courier</h5>
	<p>
		As mentioned in the setup , switching on debugging for Courier is easy:
		<code>sudo vi /etc/courier/authdaemonrc</code>
		<code>DEBUG_LOGIN=2</code>
	</p>

	<h5>Amavis</h5>
	<p>
		You can also debug amavis:
		<code>sudo vi /etc/amavis/conf.d/50-user</code>
		And perhaps bump it up if already debugging:
		<code>$log_level = 2;</code>
	</p>

	<h6><a href="#top">Return to top</a>.</h6>

	<br/>


	<a name="test-telnet"></a>
	<h4>Telnet is your friend</h4>

	<p>
		When testing a mail server, telnet is alpha &amp; omega.
		You use it to simulate real mail servers to test responses
		by your mail server.
	</p>
	<ol>
		<li><p>First you test it on the server to exclude firewall and network issues.</p></li>
		<li><p>Then you test it from another machine to simulate an actual other mail server.</p></li>
		<li><p>Once these are working you can use proper email clients,
		however 99% I just use mutt locally when I need to test if a server is working.</p></li>
	</ol>

	<h6><a href="#top">Return to top</a>.</h6>

	<br/>

	<a name="test-postfix-receive"></a>
	<h4>Can postfix receive?</h4>
	<p>
		Lets assume:
			<ul>
				<li><p>You have followed my guide up to <a href="#config-simple">basic configuration</a> at least</p></li>
				<li><p>You have entered <a href="#data">data</a> into the database</p></li>
				<li><p>The services MySQL and Postfix are running.</li>
				<li><p>If testing a fuller stack, then amavis, postgrey, clamav-daemon, spamassassin etc must also be running.</li>
			</ul>
	</p>
	<p>
		Try this locally on the server first, then try from another machine once it is working locally.
	</p>
	<p>
		Lets try and send a message to <i>xandros@example.org</i>
		(replace with your own user in this setup, or use postmaster@localhost)
		from <i>you@example.com</i>
		(again replace with a real email address you use that is not associated with this server.)
	<code>telnet localhost 25
<span class="comment"># Open the hand shake with ehlo and the server name you are connecting from...</span>
<span class="comment"># Change mail.example.com to something valid eg your servername</span>
EHLO <i>mail.example.com</i>
<span class="comment"># The mail server will then dump out some details about its capabilities, e.g.</span>
<span class="reply">&gt;250-mail.flurdy.net</span>
<span class="reply">&gt;250-PIPELINING</span>
<span class="reply">&gt;....</span>
<span class="reply">&gt;....</span>
<span class="comment"># then say who is the sender of this email</span>
MAIL FROM: <i>&lt;your@example.com&gt;</i>
<span class="reply">&gt; 250 Ok</span>
<span class="comment"># then say who the mail is for</span>
RCPT TO: &lt;<i>xandros@example.org</i>&gt;
<span class="reply">&gt; 250 Ok</span>
<span class="comment"># then enter the keyword <i>data</i></span>
data
<span class="reply">&gt; 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;&lt;/LF&gt;&lt;/CR&gt;&lt;/LF&gt;&lt;/CR&gt;</span>
<span class="comment"># enter message bodyand end with a line with only a full stop.</span>
blah blah blah
more blah
.
<span class="reply">&gt; 250 Ok; queued as QWKJDKASAS</span>
<span class="comment"># end the connection with</span>
quit
<span class="reply">&gt; 221 BYE</span></code>
	</p>


	<p>
		If while you were doing this you were tailing the <i>/var/log/mail.log</i>
		you would see some activities and if any errors occured.
		(You should probably get some complaints about missing headers as we skipped most...)
	</p>
	<p>
		If while you were doing this you were tailing the <i>/var/log/mysql/mysql.log</i> as well
		you really should have seen some activity otherwise you have a problem.
	</p>
	<p>
		If you see any errors (or worse no activity) in these log files, this is what you need to fix!
		For common problems and solutions check the <a href="edition5.html#test">previous edition</a>.
	</p>
	<br/>
	<p>
		However if no errors popped up,
		and the folder /var/mail/virtual/<i>xandros</i> now exists
		then your server can receive emails!
	</p>

	<h6><a href="#top">Return to top</a>.</h6>

	<br/>

	<a name="test-postfix-send"></a>
	<h4>Can postfix send?</h4>
	<ul>
		<li><p>You need to make sure you can first receive emails as above</p></li>
		<li><p>The services MySQL and Postfix are running.</li>
	</ul>
	<p>
		Basically you just tested that above,
		but we need double check if it can send out to other servers.
		Again we will first test locally, which should work,
		then remotely which introduces many possible problems.
		<code>telnet localhost 25
<span class="comment"># Open the hand shake with ehlo and the server name you are connecting from...</span>
<span class="comment"># This time it has to be the name of your server</span>
EHLO <i>mail.example.org</i>
<span class="comment"># The mail server will then dump out some details about its capabilities, e.g.</span>
<span class="reply">&gt;250-mail.flurdy.net</span>
<span class="reply">&gt;250-PIPELINING</span>
<span class="reply">&gt;....</span>
<span class="reply">&gt;....</span>
<span class="comment"># then say who is the sender of this email, which is a local user</span>
MAIL FROM: <i>&lt;xandros@example.org&gt;</i>
<span class="reply">&gt; 250 Ok</span>
<span class="comment"># then say who the mail is for which is an external address e.g. gmail etc.</span>
RCPT TO: &lt;<i>you@example.com</i>&gt;
<span class="reply">&gt; 250 Ok</span>
<span class="comment"># then enter the keyword <i>data</i></span>
data
<span class="reply">&gt; 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;&lt;/LF&gt;&lt;/CR&gt;&lt;/LF&gt;&lt;/CR&gt;</span>
<span class="comment"># enter message bodyand end with a line with only a full stop.</span>
blah blah blah
more blah
.
<span class="reply">&gt; 250 Ok; queued as QWKJDKASAS</span>
<span class="comment"># end the connection with</span>
quit
<span class="reply">&gt; 221 BYE</span></code>
	</p>
	<p>
		We have to assume receiving works above so no need to tail mysql's logs.
		However if any rejection errors occured in the mail.log then you have an error.
	</p>
	<p>
		However if no errors occured and you see in the log something like this:
		<code>Dec 17 10:25:45 <i>servername</i> postfix/smtp[12345]: 12345678: to=<i>&lt;you@example.com&gt;</i>, relay=127.0.0.1[127.0.0.1]:10024,
delay=15, delays=15/0.01/0.02/0.11, dsn=2.0.0, status=sent (250 2.0.0 Ok, id=12345-09, from MTA([127.0.0.1]:10025):
250 2.0.0 Ok: queued as 1234567)</code>
		Then the sending emails work!
	</p>

	<h6><a href="#top">Return to top</a>.</h6>

	<br/>

	<div class="tees">
			<a href="http://flurdy.spreadshirt.com/kill-bill-A3826976"><img
				src="http://image.spreadshirt.com/image-server/image/composition/4198589/view/1/producttypecolor/7/type/png/width/190/height/190"
				alt="Kill Bill" style="width: 150px; height: 150px;"
				onmouseover="this.src='http://flurdy.spreadshirt.com/image-server/image/product/4198589/view/1/producttypecolor/7/type/png/width/190/height/190'"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/image/composition/4198589/view/1/producttypecolor/7/type/png/width/190/height/190'"
				align="right" title="t-shirt by flurdy (US)" vspace="5" hspace="5"/></a>
	</div>

	<a name="test-courier"></a>
	<h4>Can courier read emails</h4>
	<ul>
		<li><p>You need to make sure you can first receive emails as above</p></li>
		<li><p>You need to make sure you can send emails as above</p></li>
		<li><p>You need to make sure you have received an email and the folder /var/mail/virtual/<i>xandros</i> exists</p></li>
		<li><p>The services MySQL, courier-authdaemon and courier-imap are running.</li>
	</ul>
	<p>
		There is not too much you can test via telnet for courier.
		But you can check if it is up and you can connect to it.
		<code>telnet 127.0.0.1 143
<span class="reply">Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
* OK [CAPABILITY IMAP4rev1 UIDPLUS CHILDREN NAMESPACE THREAD=ORDEREDSUBJECT THREAD=REFERENCES SORT
  QUOTA IDLE ACL ACL2=UNION STARTTLS LOGINDISABLED] Courier-IMAP ready. Copyright 1998-2008
  Double Precision, Inc.  See COPYING for distribution information.</span></code>
		The rest you would have to test via a proper email IMAP client.
	</p>

	<a name="test-amavis"></a>
	<h4>Can amavis check and pass emails along?</h4>
	<ul>
		<li><p>You need to make sure you can first receive emails as above</p></li>
		<li><p>You need to make sure you can send emails as above</p></li>
		<li><p>You need to make sure you have received an email and the folder /var/mail/virtual/<i>xandros</i> exists</p></li>
	</ul>
	<p>
		You can check if the service is responding:
		<code>telnet 127.0.0.1 10024
<span class="reply">Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
220 [127.0.0.1] ESMTP amavisd-new service ready</span></code>
	Then just tail <i>/var/log/mail.log</i> for any problems.
	</p>

	<h4>Other's solutions</h4>

	<p>
		In addition to the 100s of solutions in the forum threads, some have published their issues and solutions as well:		
	</p>
	<ul>
		<li><p><a href="http://idev.ge/postfix-mta-configuration-problems-and-solutions-ubuntu-12-04/">Sandro's Postfix MTA configuration problems and solutions Ubuntu 12.04</a></p></li>
	</ul>

</div>

<h6><a href="#top">Return to top</a>.</h6>







<a name="initialize"></a>
<h2>Initialize</h2>
<div class="section">

	<p>
		Brief hints if you receive a ready setup machine (or EC2 AMI),
		and what then to check and to customize it to your setup.
	</p>
	<ul>
		<li><p>Stop services</p></li>
		<li><p>Restrict firewall</p></li>
		<li><p>Change passwords</p></li>
		<li><p>Check configurations</p></li>
		<li><p>Set machine name</p></li>
		<li><p>Certificates</p></li>
		<li><p>Start and test services</p></li>
		<li><p>Insert data</p></li>
		<li><p>Reload postfix</p></li>
		<li><p>Open firewall</p></li>
		<li><p>Test</p></li>
	</ul>

	<h4>Stop services</h4>
	<p>
		First stop services so they wont accidentally do something.
		<code>sudo /etc/init.d/postfix stop
sudo /etc/init.d/courier-imap-ssl stop
sudo /etc/init.d/courier-imap stop
sudo /etc/init.d/courier-authdaemon stop
sudo /etc/init.d/mysql stop
sudo /etc/init.d/amavisd stop
sudo /etc/init.d/spamassassin stop
sudo /etc/init.d/clamav stop</code>
	</p>

	<h4>Restrict firewall</h4>
	<p>
		Check what the firewall rules are.
		<code>vi /etc/shorewall/rules</code>
		Refer to the <a href="#conf_firewall">firewall settings</a>.
		Restrict to just SSH access for now.
	</p>

	<h4>Change passwords</h4>
	<p>
		Next the passwords needs to be changed.
		For both the system and mysql.
	</p>
	<h5>System passwords</h5>
	<p>
		Check which users are defined on the system.
		<code>cat /etc/passwd</code>
		Apart from all the system ones,
		there should probably be none (if EC2 AMI) or
		just your user if it is a standard Ubuntu install.
		If there are some users, you need to change
		their passwords.
	</p>
	<h5>SSH Access</h5>
	<p>
		Next we check whom got SSH access.
		If there was any users defined,
		check their home folders for ssh keys.
		<code>cat /home/<i>username</i>/.ssh/auth*</code>
		Remove any you do not expect to be there.
		Next check if and which specific users has been defined
		for SSH access in
		<code>vi /etc/ssh/sshd</code>
		Usually this is fine.
	</p>
	<h5>MySQL passwords</h5>
	<p>
		First you need to change the root mysql user.
		If none has been set do this
		<code>mysqladmin -u root password <i>new_password</i></code>
		Otherwise do this and you will be prompted for the old password
		<code>mysqladmin -u root password <i>new_password</i> -p</code>
	</p>
	<p>
		Then the default mail user as well.
		If you know the old password
		<code>mysqladmin -u mail password <i>new_password</i> -p</code>
		Otherwise log into mysql as root:
		<code>mysql -u root -p</code>
		Enter new root password specified above, then:
		<code>update mysql.user set password=password('<i>apassword</i>') where user='mail';
flush privileges;</code>
		You may	need to revisit the top of <a href="#conf-simple-database">MySQL section</a>
		to re-grant the mail use rights on the database.
	</p>
	<p>
		If you do not know the old root password,
		you have to restart mysql without grant rights. Google it... :)
	</p>
	<p>
		Update postfix mysql configuration files with the new password.
		<code>sudo vi /etc/postfix/mysql*</code>
		<code>password=<i>apassword</i></code>
		Update courier's authmysql file with the new password as well.
		<code>sudo vi /etc/courier/authmysqlrc</code>
		<code>MYSQL_PASSWORD <i>apassword</i></code>
	</p>
	<p>
		If SASL is set up, then you need to update its passwords.
		First in postfix SASL file:
		<code>sudo vi /etc/postfix/sasl/smtpd.conf</code>
		<code class="document">sql_passw: aPASSWORD</code>
		Then on both lines in:
		<code>sudo vi /etc/pam.d/smtp</code>
		<code class="document">passwd=aPASSWORD</code>
	</p>

	<h4>Check configurations</h4>
	<p>
		You should scan the postfix, courier, etc. configurations
		to check if they match what you expect.
	</p>

	<h4>Set machine name</h4>
	<p>
		Now you need to define your machine name,
		e.g. something like <i>smtp.yourdomain.com</i>.
		You need to define it in
		<code>sudo vi /etc/mailname</code>
		And then your domain name in
		<code>sudo vi /etc/postfix/main.cf</code>
		under the mydomain setting
		<code>myorigin=<i>yourdomain.com</i></code>
		It could also be smart to check what the unix hostname is specified
		as
		<code>hostname</code>
		This can be reset by
		<code>sudo hostname <i>smtp.yourdomain.com</i>.</code>
		All though this does not have to be the same as your postfix mail server name.
		You may want to speficiy some hosts in hosts file as well,
		<code>sudo vi /etc/hosts</code>
		<code>127.0.0.1 localhost.localdomain localhost
127.0.0.1 <i>smtp.yourdomain.com smtp</i></code>
	</p>

	<h4>Certificates</h4>
	<p>
		You could go along with the generated certificates
		(if they are there, default for Ubuntu).
		Or if you could create new ones with the correct machine name in them.
		Especially if this a mail server used by many, and authenticiy is important.
		Follow the <a href="#config-secure-tsl">TLS certificate instructions</a> for
		Postfix and Courier.
	</p>

	<h4>Start and test services.</h4>
	<p>
		Next you need to start your mail services and test them.
		<code>sudo /etc/init.d/mysql start
sudo /etc/init.d/spamassassin start
sudo /etc/init.d/clamav start
sudo /etc/init.d/amavisd start
sudo /etc/init.d/postfix start
sudo /etc/init.d/courier-imap-ssl start
sudo /etc/init.d/courier-imap start
sudo /etc/init.d/courier-authdaemon start</code>
	</p>
	<p>
		So test tjenestene via <a href="#test">testing section</a>.
	</p>

	<h4>Insert data<h4>
	<p>
		Insert your mail domains, aliases and users using the  <a href="#data">data section</a>.
	</p>
	<p>
		Some times there are test data already in the database. Remove them.
		E.g.;
		<code>mysql -u mail -p<i>apassword</i> maildb</code>
		<code>delete from domains where domain = 'bar.com';
delete from aliases where mail = 'foo@bar.com';</code>
	</p>

	<h4>Open firewall</h4>
	<p>
		Then open up the firewall, follow the world access bit in the <a href="#conf_firewall">firewall configuration</a>.
		Voila. Up and running. Well we hope.
	</p>

</div>
<h6><a href="#top">Return to top</a>.</h6>


<a name="extend"></a>
<h2>Extend</h2>
<div class="section">

	<div class="tees">
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/Kill-Bill-colour-3621063"><img
				src="http://image.spreadshirt.com/image-server/image/product/4064502/view/1/type/png/width/190/height/190"
				alt="Kill Bill" style="width: 150px; height: 150px;"
				onmouseover="this.src='http://image.spreadshirt.com/image-server/image/design/3257345/type/png/width/190/height/190'"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/4064502/view/1/type/png/width/190/height/190'"
				align="right" title="t-shirt by flurdy (US)" vspace="5" hspace="5"/></a>
	</div>

	<p>
		Please refer to <a href="edition5.html#ext">previous edition</a>
		for how and why you can extend this mail server.
	</p>

	<p>
		By now you should have a fully working system.
		No point extending and complicating it untill then.
		What next?
		There are many ways to extend the server,
		to create your own powerfull customized version.
	</p>
	<ul>
		<li><p><a href="#ext_mx">Remote MX mail backup</a><p>
			<ul>
				<li><p><a href="#ext_mx_recipient">Relay recipient lookup</a><p></li>
			</ul>
		</li>
		<li><p><a href="#ext_back">Local file backup</a><p></li>
		<li><p><a href="#ext_spf">Sender ID &amp; SPF</a><p></li>
		<li><p><a href="#ext_pyzor">Spam reporting</a><p></li>
		<li><p><a href="#ext_list">White/Black lists</a><p></li>
		<li><p><a href="#ext_pgp">PGP &amp; S/MIME</a><p></li>
		<li><p><a href="#ext_reloc">Relocation notice</a><p></li>
		<li><p><a href="#ext_pop">Pop-before-SMTP</a><p></li>
		<li><p><a href="#ext_admin">Admin Software</a><p></li>
		<li><p><a href="#ext_reply">Auto Reply</a><p></li>
		<li><p><a href="#ext_block">Block Addresses</a><p></li>
		<li><p><a href="#ext_throttle">Throttle Output</a><p></li>
		<li><p><a href="#ext_mlist">Mail Lists</a><p></li>
		<li><p><a href="#ext_gmail">Google Apps / GMail</a><p></li>
		<li><p><a href="#ext_round">Roundcube webmail</a><p></li>
		<li><p><a href="#ext_brute">Brute Force</a><p>
			<ul>
				<li><p><a href="#ext_brute_deny">DenyHosts</a></p></li>
				<li><p><a href="#ext_brute_fail">fail2ban</a></p></li>
			</ul>
		</li>
		<li><p><a href="#ext_sug">Sugestions?</a><p></li>
	</ul>

	<p>
		Some of these sections can be brief as they
		are not core to this howto.
	</p>

	<a name="ext_mx"></a>
	<h3>Remote MX mail backup</h3>

		<p>
		With MX backup loosing emails are unlikely.
		</p>
		<p>
		Normally if someone sends an email destined for you,
		their server will try and connect to your server.
		If it can't reach your server for whatever reason
		( it is down, dns issues, there is network problems, or just too busy ),
		the other server will back off and try again in a bit.
		How many and for how long it will try again is determined
		by the sending server. Some of them are not very patience,
		and it will report undelivered after only a few attempts.
		So you would have lost that email.
		</p>
		<p>
			If you had specified a backup MX,
			this email may not have been lost.
			Upon first failure to connect to your server,
			the sender would see if there is any alternative server
			to send to. So it connects to your backup mx server.
			This server spools and queues your message
			and will try at intervals to send the message to you.
			It too will though eventually give up.
		</p>
		<p>
			What is the difference?
			Simple, you (or whoever controls the backup mx )
			is in control how long and often to try connecting
			to your machine.
			So if you have a reasonable values and your server
			is not down for weeks, no mail is lost.
		</p>
		<p>
			How to implement it?
			First edit the DNS records again,
			and add a backup mx with a higher value.
		</p>


	<code><span class="comment"># your server details</span>
<i>domain.tld</i>	IN	MX	10	<i>your.mailserver.name.tld</i>
<span class="comment"># new backup server</span>
<i>domain.tld</i>	IN	MX	20	<i>your.backupserver.name.tld</i></code>

	<p>
		Now presuming the other backup mx is a postfix
		server identical to this, or you are backuing up someone else's
		server;
		Go into mysql and create this tables:
	</p>

	<code>CREATE TABLE `backups` (
	`pkid` smallint(6) NOT NULL auto_increment,
	`domain` varchar(128) NOT NULL default '',
	`transport` varchar(128) NOT NULL default ':[]',
	`enabled` smallint(6) NOT NULL default '1',
	PRIMARY KEY  (`pkid`),
	UNIQUE KEY `domain` (`domain`)
);</code>

	<p>
		Then still on the backup server,
		edit main.cf and add these:
	</p>

	<code>relay_domains = mysql:/etc/postfix/mysql_backups.cf
transport_maps = mysql:/etc/postfix/mysql_transport.cf</code>

	<p>
		You may choose to have this as the last line in the file,
		as you may use small cron jobs to modify this ip address,
		if you don't have a permanent static address.
		It should contain your IP addres, hence if you do not
		have a very static IP address, then you need some way of
		automatic edit the postfix main.cf file.
	</p>

	<code>proxy_interfaces = <i>1.2.3.4</i></code>


		<p>
			If someone comes with a better way,
			<a href="#contact">then let me know</a>.
		</p>
		<p>
			Next create this file /etc/postfix/mysql_backups.cf
		</p>


	<code>user=mail
password=<i>apassword</i>
dbname=maildb
table=backups
select_field=domain
where_field=domain
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>

	<p>Next create this file /etc/postfix/mysql_transport.cf</p>

	<code>user=mail
password=<i>apassword</i>
dbname=maildb
table=backups
select_field=transport
where_field=domain
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>


		<p>
		You noticed I added a transport lookup.
		This is a field in both the domain and the backup tables.
		In domains it is used to determine how to deliver
		the email, ie either virtual (correct) or local
		(not used in this howto).
		When backing up servers, your also need to specify
		in the transport field how to connect to the correct servers.
		</p>
		<p>
		Say you are backup for a friends server, mail.friend.com,
		for the domains of friend1.com and friend2.com.
			So you should insert this into your backup table.
		</p>


	<code>INSERT INTO backups (domain,transport)
VALUES ('<i>friend1.com</i>' , ':[<i>mail.friend.com</i>]' ),
('<i>friend2.com</i>' , ':[<i>mail.friend.com</i>]' );</code>


		<p>
		The :[] tells to connect directly to this server,
		not doing any more look ups for valid MX servers.
		</p>
		<p>
			This should now work fine.
			Further tweaking of the queue values,
			review these and modify as appropriate.
			Shorter warning times are good for the sender,
			so that they realise the email has not arrived yet,
			but may also be annoying. Tradeoffs..
			Look in the first <a href="#config_mta">main.cf configurations</a>
			for ways to do so.
		</p>

	<a name="ext_mx_recipient"></a>
	<h4>Relay recipient lookup</h4>
	<p>
		Unfortunately spammers are using backup mx as a way to saturate the networks with invalid emails,
		known as <a href="http://en.wikipedia.org/wiki/Backscatter_(e-mail)">backscatter mail</a>.
	</p>
	<p>
		They simply lookup a domain's MX servers and connect directly to one of the lower priority servers
		whom may be just a backup mx. This server if configured as above will not check for valid addresses aliases
		but will accept and queue all emails for the domain's it is configured as a backup mx for.
		These will then be delivered by the server later to the primary MX server,
		whom will then maybe reject them as the aliases are not valid. However the sender addresses
		are often invalid and a long trail of reject messages to and forth around the net follows...
	</p>
	<p>
		To avoid this you can enable relay recipient lookup in Postfix.
	</p>
	<p>
		Edit <i>/etc/postfix/main.cf</i> and add:
		<code class="document">relay_recipient_maps = mysql:/etc/postfix/mysql_relays.cf</code>
		Then create a new file <i>/etc/postfix/mysql_relays.cf</i>
		<code class="document">user=mail
password=<i>apassword</i>
dbname=maildb
table=relays
select_field=recipient
where_field=recipient
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>
		Then add the following MySQL table:
		<code>CREATE TABLE `relays` (
	`pkid` smallint(6) NOT NULL auto_increment,
	`recipient` varchar(120) NOT NULL default '',
	`enabled` tinyint(1) NOT NULL default '1',
	`status` varchar(10) NOT NULL default 'OK',
	PRIMARY KEY  (`pkid`),
	UNIQUE KEY `recipient` (`recipient`)
);</code>
	</p>
	<p>
		If the <i>relay_recipient_maps</i> setting is set, then postfix will <b>reject</b>
		all email addresses not specificed in this table.
		As with many postfix lookups, it will recursively search for a match from the full address.
	</p>
	<p>
		In the following examples, emails to <i>john@example.com</i>
		are the only emails that will be accepted for the whole <i>example.com</i> domain.
		<br/>
		However for <i>@example.org</i> all emails will be accepted for backup,
		except any for <i>support@example.org</i> which will be rejected.
		<code>insert into relays (recipient,status) values
		('<i>john@example.com</i>','OK'),
		('<i>support@example.org</i>','REJECT'),
		('<i>@example.org</i>','OK');</code>
	</p>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_back"></a>
	<h3>Local file backup</h3>
	<p>
		Here is rough backup script to backup your configurations
		and mail folders.
		You may want to backup the folders separately
		as they can quickly grow to GBs.
		Adding this to a cronjob automates this process.
		Be aware that you should
		stop postfix and courier while backing up the
		mail folders. And that if they have grown large,
		that this may take some time.
	</p>

<code>tar czf mail-config.xxxxx.tgz /etc/postfix /etc/courier /etc/spamassassin /etc/clamav /etc/amavis /etc/mysql/my.cnf
tar czf mail-fold.xxxx.tgz /var/spool/mail/virtual
mysqldump -u mail -p<i>apassword</i> -t maildb &gt; data.sql
mysqldump -u mail -p<i>apassword</i> -d maildb &gt; schema.sql
tar czf mail-data.xxx.tgz schema.sql data.sql
tar cf mail.xxxxx.tar  mail-*.xxxxx.tgz </code>

	<p>
		You may combine a full backup
		with a intermediate update of what has changed recently only.
	</p>

	<code>tar --newer-mtime "2005-01-01"</code>

	<h6><a href="#top">Return to top</a>.</h6>



	<a name="ext_spf"></a>
	<h3>Sender ID &amp; SPF</h3>
	<p>
		Further security features is using Microsoft's
		Sender ID or Pobox's SPF. I'd use SPF as
		there is much argument over Sender ID.
	</p>

		<p><a href="http://spf.pobox.com/">spf.pobox.com</a></p>
		<p><a href="http://www.microsoft.com/mscorp/safety/technologies/senderid/">www.microsoft.com/mscorp/safety/technologies/senderid/</a></p>

		<p>
			SPF should limit who can send mail on behalf of your domains, and is an open design.
			I do recommend SPF, with some reservations, detailed below.
		</p>
		<p>
			While Microsoft is not always entirely evil,
			as sometimes they do nice things and make some useful software,
			I would prefer not to be locked into their Sender ID technology.
		</p>

		<h4>SPF configuration</h4>
		<p>
			The pobox site has some nice SPF generation tools to setup your SPF configuration.
			Probably best to use theirs.
		</p>
		<p>
			But the way I have my setup, is generally one domain with detailed SPF, then all other domains just with an SPF alias to it.
			e.g:
		</p>
		<p>
			Main domain DNS TXT field:
		</p>
		<code>"v=spf1 a mx a:<i>myserver.example.com</i> include:aspmx.googlemail.com include:gmail.com include:_spf.google.com ~all"</code>
		<p>
			The important elements are:
		</p>
		<ul>
			<li><p>
				I list the mail servers and websites associated with this domain (the <i>a</i> and <i>mx</i> bit).
			</p></li>
			<li><p>
				I then specifically list the name of a server I may send mail from applications automatically using addresses within this domain.
			</p></li>
			<li><p>
				As you can see I also use Google Apps with this domain, thus tell SPF to also allow all mail servers associated with google mail.
			</p></li>
		</ul>
		<p>
			Then for most of the other domains I would use this DNS TXT field:
		</p>
		<code>"v=spf1 a mx include:<i>example.com</i> ~all"</code>
		<p>
			The important elements are:
		<ul>
			<li><p>
				I list the mail servers and websites associated with this domain
			</p></li>
			<li><p>
				Then I tell SPF to also allow all mail servers associated with my main domain (<i>example.com</i>).
			</p></li>
		</ul>
		<p>
			And for all these I use <b><i>~all</i></b>!<br/>
		</p>
		<p>
			Ps. Some domains I have added an even stricter SPF, as these are domains that will never send an email.
		</p>

		<h4>SPF problem</h4>
		<p>
			It is worth noting about SPF, that you should leave the decision to whether to reject or allow
			the email to the mail servers. Therefore using <b>-all</b> instead of <b>~all</b> is not a good choice.
			Leave it to the SPAM scoring by the receiving server, like SpamAssasin does it.
			You then minimise the risk of false positives.
		</p>
		<p>
			One of the reason I do discourage -all use, is that SPF has a distinct problem:<br/>
			<b>It does not like email forwarding or use of backup MX!</b>
		</p>
		<p>
			Consider this: Your address of <i>lulu@hoopa.com</i> sends a joke email to a few friends.
			One of these is <i>trixie@bellbell.org</i>.<br/>
			Trixie's email address is actually an alias and forwards the email to her private webmail account on <i>hotmailnot.com</i>.
		</p>
		<p>
			Now if your domain, <i>hoopa.com</i>, have a strict SPF set up, which only allows emails to be sent by its mail server.
			And you/the mail admin has added <i>-all</i> to the SPF, which tells other server to reject emails not from your server.
			This you think makes sense, spammers can not use your domain for spoof emails.
		</p>
		<p>
			So what happens: bellbell.org receives the email from lulu, and possible checks the SPF, which is OK, and forwards it on to hotmailnot.com.<br/>
			However if hotmailnot.com also checks SPF, it will receive the email from bellbell.org, check the SPF to see bellbell.org's mail server is allowed to send emails on behalf hoopa.com. SPF will say No!, and with the -all, hotmailnot.com email server will reject the email!
		</p>
		<p>
			2nd scenario if lulu email trixie directly at hotmailnot.com,
			but hotmailnot.com main mail server was down, and email was sent to the backup mx server.
			When the main server came online again, and the backup spooled the email back to it,
			the SPF would again fail as the hoopa.com's SPF would not mention hotmailnot.com backup mx as an allowed mail server.

		</p>
		<p>
			<b>Solution</b>: <br/>
			Of course you can not list all possible forwarding / backup mx email server that your domain's users might at some point email!<br/>
			I simple just use the ~all option. Which simple say it is not the expected server, but probably ok. <br/>
			And if this is added to a scoring by the receiver, then the accumulated spam score might be enough to reject dodgy emails.
		</p>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_pyzor"></a>
	<h3>Spam reporting</h3>
	<h6 class="red">todo</h6>

		<p>
			Reporting spam to Pyzor, Razor and SpamCop,
			for collaboration in spam fighting.
		</p><p>
			More detail on <a href="http://www.spamcop.net/">SpamCop is here</a>.
		</p><p>
			<a href="http://pyzor.sourceforge.net/">pyzor.sourceforge.net</a>
		</p><p>
			<a href="http://razor.sourceforge.net">razor.sourceforge.net</a>
		</p>


	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_list"></a>
	<h3>White/Black Lists</h3>
	<h6 class="red">todo</h6>

		<p>
			You can implement white and black lists
			to explicitly allow or block domains and users.
		</p>
		<p>
			You have already visited the option
			of a <a href="#config-simple-mta">blackhole list of known open relays</a>
			in the postfix configuration.
		</p>
		<p>
			You can implement further lists inside Postfix or SpamAssassin.
			Amavisd-new already has a few well known white/black listed items
			in its config files.
			SpamAssissin also as a feture to automaticly learn white lists.
		</p>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_pgp"></a>
	<h3>PGP &amp; S/MIME</h3>
		<p>
			Adding support for GnuPG and S/MIME increases
			indiviual security.
		</p>
		<p>
			This is not implemented on the postfix server side,
			as this totally a client side option.
		</p>
		<p>
			However SquirrelMail has a GnuPG option.
			It is a plugin that can be downloaded from their website.
			Which can then be enabled via SquirrelMail's
			config script.
		</p>


		<p>
			Here is how to create a GnuPG key pair.
		</p>

	<code><span class="comment"># check you have not already got a key</span>
gpg --list-keys
<span class="comment"># then create one</span>
gpg --gen-key</code>


		<p>
			To import GnuPG into Evolution;
			in your settings/preferences
			edit your account settings and
			add you private key under the security tab.
			The private key is found via listing the GnuPG
			keys as above, then it is the 8 characters
			after the "sub 1024g/" bit of you key.
		</p>
		<p>
			To use GnuPG with	Thunderbird
			you need to install
			<a href="http://www.mozdev.org">EnigMail</a>.
		</p>
		<p>
			S/MIME is another way to encrypt and/or sign messages.
			You can create you own certificate
			or use known organizations like
			<a href="http://www.thawte.com">Thawte</a>.
			(Thawte was originally set up by the Ubuntu founder)
		</p>


	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_reloc"></a>
	<h3>Relocation notice</h3>
	<p>
		If people change addresses,
		a bounced message stating so
		if people send email to the old address
		is quite useful.
		To implement this in postfix,
		frst create a lookup table in the database.
	</p>
	<code>CREATE TABLE `relocated` (
`pkid` smallint(6) NOT NULL auto_increment,
`oldadr` varchar(128) NOT NULL default '',
`newadr` varchar(128) NOT NULL default '',
`enabled` tinyint(1) NOT NULL default '1',
PRIMARY KEY  (`pkid`),
UNIQUE KEY `oldadr` (`oldadr`)
) ;</code>

	<p>Then add this to /etc/postfix/main.cf</p>

	<code>relocated_maps = mysql:/etc/postfix/mysql_relocated.cf</code>

	<p>The create this file /etc/postfix/mysql_relocated.cf</p>

	<code>user=mail
password=<i>apassword</i>
dbname=maildb
table=relocated
select_field=newadr
where_field=oldadr
hosts=127.0.0.1</code>

	<p>
			Then if pete@domain1.com has changed address to
			pete.jones@another.org:
	</p>

	<code>INSERT INTO relocated (oldadr,newadr)VALUES
('<i>pete@domain1.com</i>','<i>pete.jones@another.org</i>');</code>

	<p>
		If anyone sends an email to pete@domain.com,
		they will get a message back stating he has changed address
		to pete.jones@another.org.
	</p>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_pop"></a>
	<h3>Pop-before-SMTP</h3>
	<p>
		If SASL didn't work, or you are using clients which
		dont support it, the Pop-Before-SMTP is an easy way
		around that issue, so that people externally can
		still securly send mail via your server.
	</p>
	<p>
		Refer to my
		<a href="edition2.html#send">2nd edition</a>
		on Pop-before-SMTP	setup.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_admin"></a>
	<h3>Admin software</h3>
	<h6 class="red">todo</h6>
	<p>
		Trying out a few admin software might make you life
		easier, if phpMyAdmin gets to crude.
		<a href="http://www.google.com/search?q=postfix+admin">Quick search</a>
		</p>
		<p>More to come later.</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_reply"></a>
	<h3>Auto Reply</h3>
	<h6 class="red">todo</h6>
		<p>
			Postfix have now features to auto reply to an email,
			while still delivering it to its alias.
		</p>
		<p>

		</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_block"></a>
	<h3>Block Addresses</h3>
		<p>
		If you use catch alls,
		which are useful for some domains,
		then eventually some addresses will be target for spam.
		You can then either stop the catch all,
		or stop indivdual addresses.
		</p>
		<p>
			By implementing a lookup
			and adding this restriction to smtpd_recipient_restrictions
			accomplises this.
		</p>
	<code>check_recipient_access mysql:/etc/postfix/mysql_block_recip.cf,</code>

	<code>smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, \
	check_recipient_access mysql:/etc/postfix/mysql_block_recip.cf, \
	reject_non_fqdn_recipient, reject_unauth_destination, \
	check_relay_domains</code>

	<p>
		Beware of the order is important here, if any options says ok before check_recipient_access it will ignore it.
		</p>
		<p>
			Next create mysql_block_recip.cf to lookup addresses.
			Either create a another table,
			or add a blocked field to aliases table.
		</p>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_throttle"></a>
	<h3>Throttle Output</h3>
	<h6 class="red">todo</h6>
	<p>
		For some users with restrictions on bandwidth,
		you may wish to control how much mail is sendt out.
		Postfix has long refused to implement these features,
		out of ideolocial beliefs that mail servers should
		not be restricted.
		However there are some ways around this.
		More to come later.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_mlist"></a>
	<h3>Mail Lists</h3>
	<p>
		<p>
			Rich Brown has written a howto on adding Mailman,
			a mail list program, to my howto.
			<a href="http://freemars.org/howto/mailman.html">Click here</a> to read it.
		</p>
		<p>
			Do note it is not part of my howto,
			so do not contact me regarding it.
			And although I think it is fine,
			I can't guarantee it will work.
		</p>
		<p>
			If you do need assistance or need to talk about it,
			contact Rich via
			 <a href="http://freemars.org/howto/mailman.html">his howto</a>
			 or use the
			<a href="#contact">forums</a>
			for this howto.
		</p>
	</p>
	<p>
			If you want a simple mailling list,
			it can be implemented
			by simply seperating aliases in the
			destination field in the aliases table with a comma.
	</p>

	<code>INSERT INTO aliases (mail,destination) VALUES
( 'listof@domain.com' , 'john@ppp.com,vic@domain.com,jj@somewhere.tld' );</code>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_gmail"></a>
	<h3>Google Apps / GMail</h3>
	<p>
		I have for various reasons integrated some Google Apps hosted
		domains into my mail server. And you can still have good control
		over the addresses by using your server with Google Apps.
	</p>
	<p>
		More information on <a href="http://www.google.com/a/">Google Apps</a>.
	</p>
	<p>
	<h4>Why</h4>
		<ul>
			<li><p>Some already have their domain's email hosted with Google.</p></li>
			<li><p>Some people prefer Google's web based interface.</p></li>
			<li><p>Temporary Migrations.</p></li>
			<li><p>Include Google's security features on top of yours.</p></li>
		</ul>
	</p>
	<h4>How</h4>
	<h5>Options</h5>
		<p>
			The easiest and simples solution is not to have a domain MXed to your server,
			and simply alias email to those domains.
			eg All email to joeblogs.co.uk hosted on your server
			are forwarded to joeblogs.com hosted with google.
		</p>
		<p>
			You may set up your own server to simple be a mail server backup (mx)
			for a domain hosted with google.
			If you are the first priority in the MX details of the DNS, you still
			have some control, but not all will obey the priority listing.
			E.g. spammers, but some valid senders as well.
		</p>
		<p>
			However the one I use and the option where you are most in control
			is to keep you server as the only MX server in the DNS.
			And only forward certain aliases onto Google after all your servers checks.
			Other aliases and user can just use your mail server if you prefer.
			I will explain how to do this in the next steps.
		</p>
	<h5>DNS</h5>
	<p>
		You only put your mail server as the mx for the domain in question.
		Google will complain about this, as it will not be able to verify that
		email is setup correctly. Ignore this as it will still accept emails.
	</p>
	<h5>MySQL tables</h5>
	<p>
		You setup you aliases as normal.
		However you domain table needs tweaking.
		This is because otherwise your server
		will just forward the email to itself.
		You can actually specify aliases in the domain table.
	</p>
	<h4>Example</h4>
	<p>
		If for example:<i>joe@bloggs.com</i> wants to use gmail. <i>mary@bloggs.com</i> does not.
	<!--	Everyone at <i>smith.com</i> wants to use gmail. -->
	</p>
	<!--
	<p>
		So basically you server, either will have no information about <i>smith.com</i>
		or act as abackup mx server for that domain.
		<i>smith.com</i> DNS will mainly ahve Google Apps's MX servers.
		To act as a <a href="#ext_mx">backup mx</a>:
		<code>insert into backups (domain,transport,enabled) values ('smith.com','',1);</code>
	</p>
	-->

	<p>
		If not already configured as a backup mx:<br/>
		Add a transport lookup to your <i>/etc/postfix/main.cf</i> file:
		<code class="document">transport_maps = mysql:/etc/postfix/mysql_transport.cf</code>
		Then create <i>/etc/postfix/mysql_transport.cf</i> file:
		<code class="document">user=mail
password=<i>apassword</i>
dbname=maildb
table=backups
select_field=transport
where_field=domain
hosts=127.0.0.1
additional_conditions = and enabled = 1</code>
	</p>
	<p>
		Assuming there are no <i>bloggs.com</i> data in any tables (domain,alias,users,relays,backups):

		<code>insert into backups (domain,transport) values
		('<i>joe@bloggs.com</i>','smtp:[aspmx.l.google.com]:587'),
insert into domains (domain,transport) values
		('<i>bloggs.com</i>','virtual:');
insert into aliases (mail,destination) values
		('<i>joe@bloggs.com</i>','<i>joe@bloggs.com</i>'),
		('<i>mary@bloggs.com</i>','<i>mary@bloggs.com</i>');
insert into users (id,name,maildir,crypt) values
		('<i>mary@bloggs.com</i>','<i>mary</i>','<i>bloggs.com/mary</i>',encrypt('<i>maryspassword</i>', CONCAT('$5$', MD5(RAND()))) );</code>

		The domains insert is the interesting one.
		The transport map lookup checks recursively for an alias match and will first look
		for <i>user@domain</i> before it looks at the general <i>bloggs.com</i> for which transport to use.
		The square brackets around <i>aspmx.l.google.com</i> indicates that this server
		will not lookup for mx settings for this domains DNS, but instead connect directly.
		(This can avoid never ending recursive lookups/relays)
	</p>
	<p>
		Note if you have <a href="#ext_mx">backup mx</a> configured and chosen to enable relay recipient lookup to avoid backscatter mail spam,
		then you need to add your Google Apps users to the relays table:
		<code>insert into relays (recipient,status) values ('<i>joe@bloggs.com</i>','OK');</code>
		Refer to <a href="#ext_mx">backup mx</a> section for creation of this table.
	</p>

	<h4>TLS certificate</h4>
	<p>
		If you have set your server up to <a href="#conf-secure-crypt">prefer TLS</a>
		then you should add Google's signing authority to your server's root certificate list.
		Google used to use Thawte but now use Equifax.
		On the latest Ubuntu releases this is no longer needed as it is already included.
	</p>
	<p>
		Download the Equifax Secure Certificate Authority certificate
		<a href="http://www.geotrust.com/resources/root-certificates/">from their website</a>
		(the base-64 encoded):
		<code>wget http://www.geotrust.com/resources/root_certificates/certificates/Equifax_Secure_Certificate_Authority.cer;</code>
		You need to fix the line endings in this file by either using sed:
		<code>sed -i 's/.$//' Equifax_Secure_Certificate_Authority.cer;</code>
		Or install a tiny util:
		<code>sudo apt-get install tofrodos;
fromdos Equifax_Secure_Certificate_Authority.cer;</code>
		Put it into your certificate root folder:
		<code>sudo chown root:root Equifax_Secure_Certificate_Authority.cer;
sudo mv Equifax_Secure_Certificate_Authority.cer /usr/share/ca-certificates/mozilla/;
cd /etc/ssl/certs;
sudo ln -s /usr/share/ca-certificates/mozilla/Equifax_Secure_Certificate_Authority.cer .;</code>
		And then append it to the root list that postfix knows about:
<code>sudo su;
cat Equifax_Secure_Certificate_Authority.cer &gt;&gt; ca-certificates.crt;
exit;
sudo service postfix restart;</code>
	</p>

	<h4>Issues</h4>
	<p>
		There are some items you should consider when integrating Google Apps.
	</p>
	<p>
		<b>Privacy</b><br />
		First there is the privacy issue.
		This is the same as if you were using Google Apps only or GMail.
		Google can and will read your email.
		However probably not a person, but they will use it for commercial reasons,
		E.g. showing relevant ads.
		Some people really hate this part and refuse to use Google's mail products.
		However I trust them a little bit, and do use it.
	</p>
	<p>
		<b>Spam</b><br />
		If you forward spam, then consider your own servers reputation.
		Should be okay though.
	</p>
	<p>
		<b>SPF</b><br />
		If you use SPF for your domain,
		consider that both your server and google will receive and send mail
		on behalf of that domain.
		Adding <code>include:_spf.google.com</code> should cover it.
	</p>
	<p>
		<b>Google internally</b><br />
		Be aware Google think they host you domain.
		So if others inside google, or using google hosted apps or GMail,
		if they email you, the email may not go via your email server,
		but directly to the Google Apps for your domain.
		That could be an issue if not all aliases you have use Google Apps.
		This needs to be tested more though.
		Especially as it may only be an issue if Google's servers are part
		of you domains MXs.
		It may be worth adding aliases in your Google Apps admin
		for the non google apps addresses
		to some user whom can handle these?
	</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_maildrop"></a>
	<h3>Maildrop, spam folder and vacation messaging</h3>
	<p>
		Villu have documented swapping in Maildrop for virtual transport
		and automatically delivering spam to a spam folder.
		(And links to a post about vacation messaging)
	</p>
	<p>
		Please <a href="http://ubuntuforums.org/showpost.php?p=7278296&postcount=223">read his post here</a>.
	</p>
<h6><a href="#top">Return to top</a>.</h6>


	<a name="ext_squirrel"></a>
<br/>
	<h3>Squirrel Mail</h3>
	<p>
		Using among others the <a href="https://help.ubuntu.com/community/Squirrelmail">https://help.ubuntu.com/community/Squirrelmail</a>
		as an updated reference.
	</p>
	<p>
		You need to copy a SquirrelMail configuration to apache.
		<code>sudo cp /etc/squirrelmail/apache.conf /etc/apache2/sites-available/squirrelmail</code>
		And enable with this:
		<code>sudo ln -s /etc/apache2/sites-available/squirrelmail /etc/apache2/sites-enabled/500-squirrelmail</code>
		Or as Florent recommends, use:
		<code>sudo a2ensite squirrelmail</code>
	</p>
	<p>
		You may accept the default apache configuration where squirrelmail is folder in all sites. But I prefer virtual hosting. But you dont need to do these next steps.
		<code>sudo vi /etc/apache2/sites-available/squirrelmail</code>
		Comment out the alias.
		<code><span class="comment"># alias /squirrelmail /usr/share/squirrelmail</span></code>
		Uncomment the virtual settings.,
		and insert your servers name.
		<code><span class="comment"># users will prefer a simple URL like http://webmail.example.com</span>
<VirtualHost *>
  DocumentRoot /usr/share/squirrelmail
  ServerName <i>webmail.example.com</i>
</VirtualHost></code>
		If you have apache SSL enabled in apache, then you can also
		uncomment the mod_rewrite section for further security.
	</p>
	<p>
		Reload apache to activate changes.
		First test if ok.
		<code>sudo apache2ctl -t</code>
		Then reload it.
		<code>sudo /etc/init.d/apache2 reload</code>
	</p>
	<p>
		You can now go to<b><i>yourdomain.com/squirrelmail/</i></b>
		or <b><i>mail.yourdomain.com</i></b> if you chose virtual host.
		This should show a squirrel mail page.
		Log in wont work yet though.
	</p>

	<h5>
		Start configuring squirrel mail.
	</h5>
	<code>sudo squirrelmail-configure</code>
	<p>
		Initially change nothing. You can customize more afterwards.
		You can browse, and exit sub menus by typing <b><i>R</i></b>.
	</p>
	<p>
		Type <b><i>2</i></b> to edit server settings.
		Type <b><i>A</i></b> to edit IMAP settings.
	</p>
	<p>
		Type <b><i>8</i></b> to edit server software.
		Enter courier.
		<code>courier</code>
	</p>
	<p>
		Now they say using TLS over localhost is a waste of time.
		But I do anyway.
		Type <b><i>7</i></b> to edit secure IMAP.
		Type <code>Y</code> to enable it.
	</p>
	<p>
		Type <b><i>5</i></b> to edit IMAP port.
		Enter <code>993</code>
	</p>
	<p>
		Type <b><i>S</i></b> to save your changes.
		Hit <b><i>Enter</i></b>.
	</p>
	<p>
		Type <b><i>Q</i></b> to exit.
	</p>
	<p>
		You can now go to <b><i>yourdomain.com/squirrelmail/</i></b>
		or <b><i>mail.yourdomain.com</i></b> if you chose virtual host.
		This should show a squirrel mail page.
		Log in will now work.
		<i>(Except you may not have defined users, check <a href="#data">data</a>
		section. And they may not have received an email which also means
		you can not view any IMAP info.)</i>
	</p>

	<p>
		Please refer to <a href="edition5.html#conf_web">previous edition</a>
		for more detail. E.g. creating address books and user preferences.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>



<br/>
	<a name="ext_brute"></a>
	<h3>Brute force</h3>
	<p>
		Preventing <a href="http://en.wikipedia.org/wiki/Brute-force_attack">Brute Force</a> attack on your server.
	</p>
	<p>
		First line of defense is the firewall.
		If they cant get to your server then they cant hack in.
		However to be a useful internet based server you have to expose
		some services, e.g. SMTP and maybe SSH.
	</p>
	<p>
		Below are two widely used ways to protect yourself.
	</p>
	<a name="ext_brute_deny"></a>
	<h4>DenyHosts</h4>
	<p>
		<a href="http://denyhosts.sourceforge.net/">Deny hosts</a> is an effective
		tool to protect your SSH service from brute force attack.
		However DenyHosts has now <a href="http://askubuntu.com/questions/433924/package-denyhosts-in-ubuntu-trusty-tahr-is-deleted-temporary-or-forever">been removed from the main repositories</a>
		due to lack of updates.
	</p>
	<p>
		To install on an older version of Ubuntu:
	</p>
	<code>sudo apt-get install denyhosts</code>
	<p>
		Tweak in <i>/etc/denyhosts.confs</i>.
		Perhaps whitelist your ips to prevent accidentally locking yourself out...
		You do this via <i>/etc/hosts.allow</i>.
	</p>
	<p>
		Read more in <a href="http://ubuntuforums.org/showthread.php?t=450853">this thread</a>
		for tweaks.
	</p>
	<p>
		To protect your server against
		distributed attack, read about
		<a href="http://denyhosts.sourceforge.net/faq.html#sync">DenyHosts' synchronisation</a> feature.
	</p>

	<a name="ext_brute_fail"></a>
	<h4>fail2ban</h4>
	<p>
		<a href="http://www.fail2ban.org/wiki/index.php/Main_Page">fail2ban</a>
		protects against a multitude of brute force attacks.
		Relevant to this guide is the protection for SMTP and IMAP.
	</p>
		<code>sudo apt-get install fail2ban</code>
	<p>
		Follow
		<a href="http://scottlinux.com/2011/05/26/prevent-postfix-brute-force/">this guide</a>
		for how to configure it.
	</p>
<h6><a href="#top">Return to top</a>.</h6>
<br/>


	<a name="ext_sug"></a>
	<h3>Suggestions?</h3>
	<p>
		If you have any suggestions to other ways of extending
		a postfix server, then fire off a mail to me via
		the <a href="#contact">contact form</a> further down.<br/>
		(Or rather, Id prefer that you write down the extension, and let me know the link! :))
	</p>
</div>
<h6><a href="#top">Return to top</a>.</h6>







<br />
<br />
<br />



<a name="ec2"></a>
<h2>Elastic Compute Cloud</h2>

<div class="section">

	<div style="float: right; margin: 0.2em;">
<SCRIPT charset="utf-8" type="text/javascript" src="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822/US/flurdy-20/8001/fd8184f1-e928-4237-9a37-4dc56a16777e"> </SCRIPT> <NOSCRIPT><A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fflurdy-20%2F8001%2Ffd8184f1-e928-4237-9a37-4dc56a16777e&Operation=NoScript">Amazon.com Widgets</A></NOSCRIPT>
	</div>
	<ul>
		<li><p><a href="#ec2">Impressions</a></p></li>
		<li><p><a href="#ec2_tips">ec2 introduction, tips and hwotos</a></p></li>
		<li><p><a href="#ec2_use">Using EC2 with this howto</a></p></li>
		<li><p><a href="#ec2_ami">Amazon EC2 Images: AMIs</a></p></li>
		<li><p><a href="#ec2_links">EC2 Links</a></p></li>
	</ul>

	<h4>Impressions</h4>

	<p>
		Easy to use.
		Anyone can use, not just big companies.
		Very useful.
		Tools are command line but simple.
		Firefox extensions work well.
		Recommended.
	</p>
	<p>
		I find it very usefull.
		Basically it is a colo hosting environment.
		Some may use it as for Saas, ie single scalable application in the cloud,
		but I use it as a hosting environment for complete servers.
	</p>

	<a name="ec2_tips"></a>
	<h4>ec2 introduction, tips and howtos</h4>
	<p>
		I have made a separate <a href="http://flurdy.com/docs/ec2/index.html">tips and howto on the use of ec2</a>
		for general server needs.
		Hope it will be useful for people.
	</p>


	<h4>How I use it for my mail servers</h4>
	<p>
		Different images to launch for different needs.
		Good way to scale backup MXs if needed.
		Can script backup to S3 of mail dirs etc.
	</p>

	<a name="ec2_use"></a>
	<h4>	Using EC2 with this howto	</h4>

	<p>
		If you plan to use EC2 to follow this howto,
		then familiarise yourself with EC2 first.
		Check the <a href="#ec2_links">links</a> further down,
		e.g. <a href="/docs/ec2/">my tips</a>.
	</p>
	<p>
		Once competent enough on EC2, launch the latest official
		<a href="http://help.ubuntu.com/community/EC2StartersGuide#Getting the images">Ubuntu ec2 image</a> or one of
		<a href="http://alestic.com">Eric Hammond images</a>.
	</p>

	<h5>Instance size</h5>
	<p>
		I run my own instances on several AWS ec2 micro size as my traffic is low.
		However the memory is too low so I also add an 2GB EBS as swap file,
		detailed in my <a href="/docs/ec2/ubuntu/">Ubuntu ec2 guide</a>.
	</p>
	<p>
		However for a medium company I recommend the small size.
		High traffic servers needs perhaps larger instances.
	</p>

	<h5>Security and backup</h5>
	<p>
		I also recommend using EBS for slight recovery of the mail spools
		if the server goes down.
	</p>
	<p>
		When using EC2 images, be aware of security groups as they restricts
		access to your server on top of the firewall.
		Initially you will need SSH (22) access, quite soon you will need SMTP
		and IMAP ports opened, 25,143,465,587 and 993, and
		eventually web server ports of 80 and 443.
		<a href="http://developer.amazonwebservices.com/connect/entry.jspa?externalID=1233&categoryID=100G">Read here</a> for tips on securing AMIs.
	</p>
	<p>
		Also do not terminate your instances without backing up your machine.
		This you can do by either create your own image.
		Or backup certain data if you got an image to instantiate from.
		Back up to S3 or your local machine.
		Create images only now and then. Backup configurations, database, maildirs
		more regularly.
	</p>
	<p>
		Once launched, follow my <a href="#initialize">Initialize</a> section.
	</p>
	<p>
		<b>1st note</b>:
		<a href="http://www.spamhaus.org">Spamhaus.org</a> lists amazons ec2 ip ranges as dynamic,
		thus many mail servers will reject emails from it.
		(Including other people using this howto.)
		But Spamhaus has a simple web page to remove ips,
		which they link to in rejection messages.
		Simple look in your logs, click on the link on follow the instructions:
		basically fill in your ip, email and state its for a mail server.
		Then Spamhaus will remove your IP from their database.
	</p>
	<p>
		<b>2nd Note</b>:
		Amazon AWS do have ec2 based email server limitations,
		so if you have a busy mail server, follow their
		<a href="http://aws.amazon.com/ec2/faqs/#Are_there_any_limitations_in_sending_email_from_EC2_instances">
		FAQ entry for removing mail throttling</a>.
		AWS will then also add a reverse IP lookup for you elastic IP to your server,
		which also helps in the spam scoring and delivery.
	</p>

	<a name="ec2_ami"></a>
	<h4>Amazon EC2 Images: AMIs</h4>
	<p>
		I used to provide ec2 AMIs.
		But these quickly got outdated so I have removed them.
	</p>


	<a name="ec2_links"></a>
	<h4>EC2 Links</h4>
	<ul>
		<li><p><a href="http://www.amazonaws.com">Amazon web services (AWS)</a></p></li>
		<li><p><a href="http://ec2.amazonaws.com">Elastic Computing Cloud (EC2)</a></p></li>
		<li><p><a href="http://s3.amazonaws.com">Simple Storage Service (S3)</a></p></li>
		<li><p><a href="http://calculator.s3.amazonaws.com/calc5.html?">AWS Cost Calculator</p></li>
		<li><p><a href="http://developer.amazonwebservices.com/connect/kbcategory.jspa?categoryID=84">EC2 Resource Centre</p></li>
		<li><p><a href="http://docs.amazonwebservices.com/AWSEC2/2008-02-01/GettingStartedGuide/?ref=get-started">EC2 Starter Guide</p></li>
		<li><p><a href="http://developer.amazonwebservices.com/connect/entry.jspa?externalID=609&categoryID=88">EC2 Firefox extension: Elasticfox</p></li>
		<li><p><a href="https://s3.amazonaws.com/ec2-downloads/elasticfox-ff3b.xpi">Elasticfox for Firefox 3</a></p></li>
		<li><p><a href="http://developer.amazonwebservices.com/connect/entry.jspa?externalID=771&categoryID=58">S3 Firefox extension: S3Fox</a></p></li>
		<li><p><a href="http://developer.amazonwebservices.com/connect/entry.jspa?externalID=931">EC2 to S3 Admin Scripts</a></p></li>
		<li><p><a href="http://alestic.com">alestic</a>, ubuntu ec2 images</p></li>
		<li><p><a href="http://www.ubuntu.com/ec2">Ubuntu ec2</a></p></li>
		<li><p><a href="http://www.ubuntu.com/cloud">Ubuntu Cloud</a></p></li>
		<li><p><a href="http://help.ubuntu.com/community/EC2StartersGuide">Ubuntu ec2 Starter Guide</a></p></li>
		<li><p><a href="/docs/ec2/index.html">My ec2 Tips and Howtos</a></p></li>
	</ul>


</div>
<h6><a href="#top">Return to top</a>.</h6>








<a name="app"></a>
<h2>Appendix</h2>

<div class="section">


	<div class="tees">
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/No-I-will-not-fix-your-computer-3827043"><img
				src="http://image.spreadshirt.com/image-server/image/product/4198687/view/1/producttypecolor/2/type/png/width/190/height/190"
				alt="No fix computer"
				onmouseover="this.src='http://image.spreadshirt.com/image-server/image/design/3120666/type/png/width/190/height/190'"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/4198687/view/1/producttypecolor/2/type/png/width/190/height/190'"
				align="right" title="t-shirt by flurdy (US)" vspace="5" hspace="5"/></a>
	</div>


	<ul>
		<li><p><a href="#author">About author</a></p></li>
		<li><p><a href="#contact">Contact</a></p>
			<ul>
				<li><p><a href="#contact_check">Checklist</a></p></li>
				<li><p><a href="#forum">Forums</a></p></li>
				<li><p><a href="#consult">Consult</a></p></li>
			</ul>
		</li>
		<li><p><a href="#app_why">Why</a></p></li>
		<li><p><a href="#references">References</a></p></li>
		<li><p><a href="#app_links">Software Links</a></p></li>
		<li><p><a href="#app_dif">Difference between Ubuntu versions</a></p></li>
		<li><p><a href="#download">Download</a></p></li>
		<li><p><a href="#app_todo">Todo</a></p></li>
		<li><p><a href="#app_log">Change Log</a></p></li>
	</ul>

	<a name="about"></a>
	<a name="author"></a>
	<h3>About author</h3>
	<p>
		<a href="http://flurdy.com">Ivar Abrahamsen</a>, an <a href="http://www.eray.co.uk">IT Consultant</a> from Norway currently living in Hampshire, UK.

		Specialising in leading teams that integrate middleware applications,
		payment systems and data processing systems using mainly Java and Scala technology stacks.

	</p>
	<h6><a href="#top">Return to top</a>.</h6>

	<a name="contact"></a>
	<a name="forum"></a>
	<a name="contact_check"></a>
	<h3>Contact</h3>

	<p>
		Remember I have <b>stood on the shoulders of <a href="#references">giants</a></b>.
		I just ended up with a system that worked for me, and decided to document its evolution.
	</p>
	<h4>Checklist</h4>

	<p>
		Before contacting, have you?:
	</p>
	<ul>
		<li><p>
			Read this document properly? Followed it step by step?<br/>
			(While we can not insist on the same setup for everyone,
			assistance is easier and more likely if less customised)
		</p></li>
		<li><p>
			Have <b>tested properly</b>?
			Applied the solutions provided in the <a href="#test">test section</a>?
		</p></li>
		<li><p>
			Read the <a href="#forum">forums</a> for solutions already posted?
		</p></li>
		<li><p>
			<b>Read the <a href="#app_faq">FAQ</a></b>?
		</p></li>
		<li><p>
			Tailed the mail.log? It usually <b>tells you what the problem is</b>!
		</p></li>
		<li><p>
			Tailed the mysql.log? If nothing happens there it should indicate something...
		</p></li>
		<li><p>
			Include a short dump of the mail.log with your post.
			(Remember to anonymise the server names, email adresses &amp; definitely passwords!)
		</p></li>
	</ul>

	<a name="forums"></a>
	<h4>Forums</h4>
	<p>
		Use the <a href="http://www.ubuntuforums.org">Ubuntu forums</a>! :)<br />
	</p>
	<ul>
		<li><p>
			<b><a href="http://ubuntuforums.org/showthread.php?t=185913">Here is a thread</a> on this specific mail server howto</b>.
		</p></li>
		<li><p>
			<b>And <a href="http://ubuntuforums.org/showthread.php?t=97600">another one</a> by me which is also used.</b>.
		</p></li>
		<li><p><b>
			Or alternatively use <a href="http://serverfault.com/questions/tagged/postfix">Server Fault</a>.
		</b></p></li>
		<li><p><b>
			If more  Postfix specific, considered the <a href="http://www.postfix.org/lists.html">postfix mailing lists</a>.
		</b></p></li>
	</ul>
	<p>
		Please participate in the forums.<br/>
		<ul>
			<li><p>If you see an issue you also have, contribute with more information.</p></li>
			<li><p>And even better if it something you may know how to solve, please <a href="http://ubuntuforums.org/showthread.php?t=185913">let people know</a>.</p></li>
			<li><p>And especially, if you post a problem, then solve it, let <a href="http://ubuntuforums.org/showthread.php?t=185913">people know what the solution was</a>! (and not just that you solved it...)</p></li>
		</ul>
	</p>
	<p>
		I am rubbish in replying to emails,
		and the forums are read and answered by people whom
		know a lot more about Postfix than me.
	</p>
	<p>
		Questions sent to me directly may not be answered for a while or at all unfortunately.
	</p>
	<h6><a href="#top">Return to top</a>.</h6>


	<a name="consult"></a>
	<h4>Consultancy and advice</h4>
	<p>
		Not to be rude, but in attempt to reduce the volume of emails I receive please consider the following:
	</p>
	<ul>

		<li>
			<p>
				If you simply want advice please use the <a href="http://ubuntuforums.org/showthread.php?t=185913">forum</a> or <a href="http://serverfault.com/questions/tagged/postfix">Server Fault</a>.
			</p>
		</li>
		<li><p>
			<a href="#references">My references</a> and the people whom follow <a href="http://ubuntuforums.org/showthread.php?t=185913">the forums</a> and the <a href="http://www.postfix.org/lists.html">postfix mailling lists</a> are much <b>more knowledgable</b> than me.
		</p></li>
		<li><p>
			People whom follow <a href="http://ubuntuforums.org/showthread.php?t=185913">the forums</a> and the <a href="http://www.postfix.org/lists.html">postfix mailling lists</a> are much <b>more likely</b> to reply than me.
		</p></li>
		<!-- <li><p>
			While I am a consultant, it is not regarding email servers. So this is not actually my field.
			I am generally contracted out as software engineer or architect within enterprise Java applications.
		</p></li> -->
		<li><p>
			I am a firm believer in: <i><a href="http://www.amatecon.com/fish.html">Give a man a fish; you have fed him for today.
			Teach a man to fish; and you have fed him for a lifetime</a></i>.
			(Playing far too much <a href="http://www.civilization.com">Civ</a> was not all wasted..)
			<br/>
			Or rather my version:
			<b>"Teach a man to fish, share the teaching,
			and you have fed many others for a lifetime"</b>.
		</p></li>
		<li><p>
			So if you have any questions,
			problems with using this guide,
			or any other issues with this guide,
			<a href="http://ubuntuforums.org/showthread.php?t=185913">please use the forum</a>.<br/>
			Then it is also an available archive for others to find solutions in the future.
		</p></li>
		<li><p>
			Any technical difference of opinion,
			<a href="http://ubuntuforums.org/showthread.php?t=185913">please use the forum</a>.
		</p></li>
		<li><p>
			Interested in Postfix, or got a technical query about it?
			Considered the <a href="http://www.postfix.org/lists.html">postfix mailling lists</a>.
		</p></li>
		<!--
		<li><p>
			I really do not have much spare time.
			And rarely do I spend to the one spare hour I get a week on mail server issues.<br/>
			While I try to be nice, setting up a server for someone else would use up my spare time that month!
		</p></li>
		-->
		<li><p>
			If you made / found an extension / alternative / translation to this tutorial, fantastic!
			<a href="#contribute">Please let me know</a>, and I'll link to it.
			And <a href="/contact">shout at me</a>, if I am slow in doing so. :)
		</p></li>
		<li><p>
			Any clear technical mistakes by me in this guide,
			then <a href="#contribute">let me know</a>,
			but perhaps <a href="http://ubuntuforums.org/showthread.php?t=185913">discuss it first in the forums</a>?
		</p></li>
		<li><p>
			If you find any spelling mistakes or broken links, <a href="#contribute">please let me know</a>.
			<br/>
			Even after 10 years since the first version people are
			still finding typos every week.
			So my initial versions must have contained only typos! :0
		</p></li>
		<li><p>
			<b>Thank you messages</b> are <a href="/contact/">very appreciated</a> however! Actually it makes my day. :)<br />
			(People whom <a href="http://shirts.flurdy.com">buy a T-shirt</a> of me makes my week.. ;p )
		</p></li>
	</ul>

	<p>
		<b>If you still want my help:</b>
	</p>
	<ul>
		<li>
			<p>
				You may purchase a complete AWS based email server by me via <a href="http://www.eray.co.uk">www.eray.co.uk</a>
				(<a href="http://www.eray.co.uk/rates/index.html">price</a>)
			</p>
		</li>
		<li>
			<p>
				Otherwise if you:
			</p>
			<ul>
				<!-- <li><p>
					are an individual or non commercial organisation
				</p></li> -->
				<li>
					<p>
						have <b>tried all the steps</b> mentioned above:
						<a href="#test">test section</a>,
						<a href="#app_faq">FAQ</a>,
						<a href="#forum">forums</a>,
						<a href="http://www.postfix.org/lists.html">mailing lists</a>.
					</p>
				</li>
				<li><p>
					understand the <i><a href="http://www.amatecon.com/fish.html">fishing</a></i> analogy
				</p></li>
				<li><p>
					then you can contact me via <a href="/contact/">flurdy.com/contact</a>
				</p></li>
			</ul>
		</li>
	</ul>
	<p>
		<i>
			10 years after the initial version of this document I think roughly
			95% of the people that do contact me directly,
			have not bothered to <a href="#test">test properly</a>
			(command line first, not straight to GUI...)
			nor read the whole guide, <a href="#app_gaq">common solutions</a> nor
			<a href="#forum">forums</a>.
			They just want me do to their work for them, for free.
			The chances of me replying to their emails are minuscule,
			I much prefer to spend time with my daughter instead :)
		</i>
	</p>
	<p>
		<i>
			However many people contribute with really good stuff in the forums,
			send me typos (frequently), or thank you notes.
			You guys are great!
		</i>
	</p>

	<h6><a href="#top">Return to top</a>.</h6>
<br/><br/>


	<a name="contribute"></a>
	<h3>Contribute</h3>

	<p>
		Ways to contribute towards this document:
	</p>

	<h5>Participate</h5>
	<p>
		Participate and respond to questions in forums,
		such as <a href="#forum">the Ubuntu ones</a>,
		or specific sites for Postfix, IMAP, etc.
	</p>

	<h5>Correct typos</h5>
	<p>
		If you spot any typos either <a href="#contact">contact me</a> about it,
		or preferably fork <a href="https://github.com/flurdy/flurdy.com-docs">github.com/flurdy/flurdy.com-docs</a>
		and send me a pull request.
	</p>

	<h5>Minor enhancements</h5>
	<p>
		If you any minor changes that will improve this document,
		or update it with a more update to date information:
		Please fork <a href="https://github.com/flurdy/flurdy.com-docs">github.com/flurdy/flurdy.com-docs</a>
		and send me a <a href="https://help.github.com/articles/using-pull-requests">pull request</a>.
	</p>


	<h5>Larger enhancements</h5>
	<p>
		For extensive changes to this document,
		please <a href="#contact">contact me</a> about it first.
		We may then decide:
	</p>
	<ul>
		<li><p>it is a good idea, and you should send me a <a href="https://github.com/flurdy/flurdy.com-docs">pull request</a></p></li>
		<li><p>or it is independent enough to host it elsewhere and just send me a <a href="https://github.com/flurdy/flurdy.com-docs">pull request</a> with the link instead</p></li>
		<li><p>or decide it is not beneficial and have a beer instead</p></li>
	</ul>

	<h5>Related HOWTOs</h5>
	<p>
		If you have written a document yourself or found a very relevant one,
		instead of including it inside this document I prefer to just link to a version hosted by you instead.
	</p>
	<p>
		Please <a href="#contact">contact me</a> about the HOWTO or even better send me a <a href="https://github.com/flurdy/flurdy.com-docs">pull request</a> with the link added to this document.
	</p>
	<p>
		If you require assistance with hosting it, please <a href="#contact">contact me</a> for suggestion or assistance.
	</p>


	<h6><a href="#top">Return to top</a>.</h6>
<br/><br/>


	<div style="float:right; padding-right: 15px;">
			<a href="http://flurdy.spreadshirt.com/us/US/Shop/Article/Index/article/I-read-your-email-3691300"><img
				style="border: 1px solid black; background-color:white; padding:3px;"
				src="http://image.spreadshirt.com/image-server/image/product/4068110/view/1/type/png/width/190/height/190"
				onmouseover="this.src='http://image.spreadshirt.com/image-server/image/configuration/6024181/type/png/width/42/height/42'"
				onmouseout="this.src='http://image.spreadshirt.com/image-server/image/product/4068110/view/1/type/png/width/190/height/190'"
				width="150" height="150" border="0" alt="I read your email"
				align="right" title="t-shirt by flurdy" vspace="5" hspace="5"/></a>
	</div>



	<a name="app_why"></a>
	<h3>Why</h3>
	<h4>Why your own mail server</h4>
	<p>
		Main reason: Because you can.
	</p>
	<p>
		Other good reasons:
		Basically it leaves you in complete control,
		to expand, customize and tweak your mail server to your needs.
		You are not dependent on 3rd party providers,
		limited by their technology constraints or your budgets.
		With your own mail server you can add as many aliases,
		users and domain as you'd like,
		be as restrictive or open about security, virus, spam,
		file sizes etc as you prefer.
		And is it is well known, frequently updated, open source application stack,
		you can also trust the software you use.
	</p>
	<p>
		And its your data. You and your data is not a product of another company.
		In theory should make your data more secure and keep your privacy.
	</p>
	<h4>Why I wrote this howto</h4>
	<p>
		When I set up my first email server I used a mix
		of other howtos on the net.
		And they were so helpful that I though I would
		contribute back with my experience.
		And it has been useful as a recipe script for
		myself every time I need to install/update a server.
	</p>
	<p>
		A less angelic reason is that back in 2003 I was setting up one mail server
		for a myself and few friends and collegues.
		Soon I was getting more request for more servers,
		and being a lazy programmer, I thought..
		"Why don't I write a howto and let them do it themselves..."
		Soon it was listed on postfix.org
		and I was getting thousands of hits and
		lots of emails. (blessing in disguise)
	</p>

	<!--
	<h4>Why I wrote this edition</h4>
	<p>

	</p>
	<p>
		Or rather why no new edition or updates for two years?
		Well basically no time or need to do so, so basically lazyness...<br />
		My last edition was written two years ago,
		and was pretty complete and thorough so my inclination
		to write a new one has been low, especially as
		my own mail server had not changed since then either.
	</p>
	<p>
		But then my server started crashing so I upgraded it to Ubuntu 8.04 which went pretty smooth, but with a few tweaks. So time for another edition.
	</p>
	<p>
		This time I expanded reliability to include
		the possibility of running backup mx
		servers using <a href="http://amazon.com">Amazon</a>'s
		<a href="http://ec2.amazonaws.com">Elastic Computing Cloud</a>.
		Note, however this is an optional extra at the end.
	</p>
	-->
	<h6><a href="#top">Return to top</a>.</h6>

	<a name="references"></a>
	<h3>References</h3>
	<ul>
			<li><p><a href="http://www.postfix.org/docs.html">Postfix howtos</a></p></li>
			<li><p><a href="http://www.amazon.co.uk/exec/obidos/redirect?tag=ivarssite-21&creative=3914&camp=526&link_code=st1&path=tg/sim-explorer/explore-items/-/0596002122/0">Kyle's book</a></p></li>
			<li><p><a href="http://techrepublic.com.com/5171-22-5030268.html">John Locke on TechRepublic</a></p></li>
			<li><p><a href="http://www.amazon.co.uk/exec/obidos/redirect?tag=ivarssite-21&creative=3930&camp=526&link_code=st1&path=tg/sim-explorer/explore-items/-/1593270011/0">Hildebrandt's book</a></p></li>
			<li><p><a href="http://sbserv.stahl.bau.tu-bs.de/~hildeb/postfix/">Hildebrandt's website</a></p></li>
			<li><p><a href="http://www.marlow.dk/postfix/">List-Petersen</a></p></li>
			<li><p><a href="http://genco.gen.tc/postfix_virtual.php">Genco Yilmaz</a></p></li>
			<li><p><a href="http://workaround.org/articles/ispmail-sarge/">Christop Haas</a></p></li>
			<li><p><a href="http://kirb.insanegenius.net/postfix.html">Nenzel &amp; Peet</a></p></li>
			<li><p><a href="http://postfixwiki.org/index.php?title=Virtual_Users_and_Domains_with_Courier-IMAP_and_MySQL">Peters</a></p></li>
			<li><p><a href="http://www.sweeney.demon.co.uk/pfix_imap_virtual.html">Matthews</a></p></li>
			<li><p><a href="http://www.phparchitecture.com/howto_show.php?id=2">Stepanov</a></p></li>
			<li><p><a href="http://www.besy.co.uk/projects/debian/woody_mail_server_howto.htm">Andy "Besy"</a></p></li>
			<li><p><a href="http://www.metaconsultancy.com/whitepapers/smtp.htm">Meta Consultancy</a></p></li>
		</ul>
	<p>New references</h3>
	<ul>
		<li><p><a href="https://www.aet.tu-cottbus.de/personen/jaenicke/postfix_tls/doc/conf.html">Postfix TLS</a</p></li>
		<li><p><a href="http://www.postfix.org/postconf.5.html">Postfix main.cf doc</a></p></li>
		<li><p><a href="http://www.greens.org/~cls/linux/howtos/smtp-auth-saslauthd.html">saslauthd</a></p></li>
		<li><p><a href="http://www200.pair.com/mecham/spam/bypassing.html">Bypassing amavisd</a></p></li>
		<li><p><a href="https://help.ubuntu.com/community/Squirrelmail">Ubuntu Help: Squirrelmail</a></p></li>
	</ul>
	<h6><a href="#top">Return to top</a>.</h6>

	<a name="app_links"></a>
	<h3>Software Links</h3>
	<p>
		Please refer to a <a href="edition5.html#app_links">previous edition</a>
		for a list of urls and suitable downloads.
		However most are unnecessary with decent package manager.
	</p>

	<a name="app_diff"></a>
	<h3>Difference between Ubuntu versions</h3>
	<p>
		I used to distinguish differences, which were available in a <a href="edition5.html#app_diff">previous edition</a>.
	</p>
	<p>
		In the last few editions I have not. I base it on the latest LTS version, and test it with the minor releases in between.
	</p>

	<a name="download"></a>
	<h3>Download</h3>
	<p>
		Please refer to the <a href="edition5.html#download">previous edition</a>
		for a complete lists of downloads that are available.
	</p>
	<p>
		However all the required software are available as .deb packages direct from ubuntu repositories.
	</p>

	<a name="app_log"></a>
	<h3>Change log</h3>
	<p>
		Brief list of latest changes.
	</p>
	<ul>
		<!--
		<li><p>
			2010-05-29:
		</p></li>
		-->
		<li><p>
			2014-05-31: Removed ec2 AMIs
		</p></li>
		<li><p>
			2013-06-30: Added contribute section.
		</p></li>
		<li><p>
			2013-01-10: Made Roundcube default webmail client.
		</p></li>
		<li><p>
			2011-11-18:
				Added fail2ban.
		</p></li>
		<li><p>
			2011-10-10:
				(Re)Added domain and DNS section
		</p></li>
		<li><p>
			2010-06-09:
			Improved Google Apps integration.
			Added backup relay recipient lookup.
			Update phpmyadmin section.
		</p></li>
		<li><p>
			2010-06-07: Updated for Ubuntu 10.04 LTS Lucid Lynx
				Modified mysql log option.
				Removed dynamic uid &amp; gid in postfix.
		</p></li>
		<li><p>
			2010-02-15:
			Redid SASL secure authentication section.
		</p></li>
		<li><p>
			2009-12-16:
			Expanded test section with text from older editions and new babble.
		</p></li>
		<li><p>
			2009-11-25:
			Bumped to edition 9!<br/>
			And added Roundcube as webmail client.
		</p></li>
		<li><p>
			2009-11-11:
			Updated to work with 9.10 Karmic Koala.
		</p></li>
		<li><p>
			2009-06-04:
			made basic server image available on ec2.
			based Canonical's official ec2 ami.
		</p></li>
		<li><p>
			2009-06-02:
			made clean server image available on ec2.
			based Canonical's official ec2 ami.
		</p></li>
		<li><p>
			2009-05-29:
			changed contact section.
		</p></li>
		<li><p>2009-05-29: started 8th edition</p></li>
	</ul>
	<p>
		Used to refer to all changes, but got too long.
		A <a href="edition5.html#app_log">previous edition</a> contains such a list.
	</p>

	<h6><a href="#top">Return to top</a>.</h6>


	<a name="app_todo"></a>
	<h3>Todo</h3>

	<ul>
		<li><p>Spell check!</p></li>
		<li><p>Remove uid and guid</p></li>
	</ul>
	<p>
		Please refer to the <a href="edition5.html#app_todo">previous edition</a>
		for some old todos....
	</p>


	<a name="app_faq"></a>
	<h3>FAQ</h3>
	<p>
		There is not yet an extensive FAQ.
	</p>
	<p>
		But please, most of the frequent questions have been asked and answered in <a href="http://ubuntuforums.org/showthread.php?t=185913">the forums</a>.<br/>
		Most are also unnecessary as following the <a href="#test">test section</a> will have solved them.
	</p>

	<p>
		Some question that frequently get sent to me, which first of all should have been asked in <a href="http://ubuntuforums.org/showthread.php?t=185913">the forums</a> and has been answered there many times, which then I tend to ignore are:
	</p>

	<ul>
		<li>
			<h5>Squirrelmail does not allow me to log in</h5>
			<p>
				This is due to many things.
				Most are due to skipping too fast forward, ignoring <a href="#test">test sections</a> etc.
			</p>
			<p>Answers:
			<ul>
				<li><p>
					<b>Does <a href="#config-simple-mta">postfix</a> work?</b><br/>
					No point trying to run before you can crawl.
					Send emails to recipients on your server,
					tail mail.log to see if everything is okay.<br/>
					Often <a href="#config-simple-database">mysql</a> is not configured properly, <a href="#test">check the mysql logs</a> for activity.
				</p></li>
				<li><p>
					<b>Have they ever received an email?</b><br/>
					If not they can not log into squirrelmail
					as the email folders will not yet exist.
				</p></li>
				<li><p>
					<b>Does <a href="#config-simple-imap">Courier</a> work?</b><br/>
					If it doesn't then you have still got some more setup to do.
				</p></li>
				<li><p>
					If all above is okay, then it may be a problem with your <a href="#config-extra-webmail">Squirrelmail setup</a>.<br/>
					Check empty spaces in squirrelmail mysql setup. More details in <a href="#test">test section</a>.
				</p></li>
			</ul>
		</li>
		<li>
			<h5>Email folders do not exist</h5>
			<p>
				Mentioned many times in this guide and forums.
			</p>
			<p>Answers:</p>
			<ul>
				<li><p>
					<b>Have they received an email?</b><br/>
					If not they you can not log into squirrelmail
					as the email folders will not yet exist.
					When receiving their first email,
					postfix will create all the necessary folders.
					If it does not your postfix setup is broken.
				</p></li>
				<li><p>
					<b>There is a program that creates the folders for you.</b><br/>
					I do not recommend it,
					as basically your postfix setup is broken
					if no folders are created, and you better fix it instead.
				</p></li>
			</ul>
		</li>
		<li>
			<h5>SASL authentication does not work</h5>
			<p>
				All lot of people have issues with SASL in certain setups.
				There are quite a few <a href="#forums">messages in the forum</a> is regarding this.
			</p>
			<p>
				SASL works for me, but I can not tell my configuration apart
				from other people's server where it does not.
			</p>
			<p>
				Workarounds or alternatives:
			</p>
			<ul>
				<li><p>
					Do you need external SMTP &amp; IMAP access?
					Or will webmail interface be sufficient for external dynamic ip clients?
					Then you do not need SASL. Restrict by IP and TLS is enough.
				</p></li>
				<li><p>
					Do you need SASL at all?
					If you accept TLS only and restrict by IP addresses
					in mynetworks it may not be necessary.
					Not an option with
					road warriors and too random dynamic IPs unfortunately.
				</p></li>
				<li><p>
					Could <a href="ext_pop">POP-before-SMTP</a> be an alternative?
				</p></li>
				<li><p>
					There are a few <a href="#forums">suggestions in the forum</a>.
				</p></li>
			</ul>
			<p>
				Note however most people assume SASL is the problem
				when another factor that is the root cause.
			</p>
		</li>
		<li>
			<h5>(!!)file(1) utility (/usr/bin/file) FAILED: run_command: can't fork: Cannot allocate memory at /usr/sbin/amavisd-new line 3077.</h5>
			<p>Running postfix on a micro instance on Amazon ec2?</p>
			<p>
				It only has 600Mb of ram and amavisd+clamav can grow too big over time.
				Restart these services, and even some times reboot...
			</p>
		</li>
	</ul>

</div>
<h6><a href="#top">Return to top</a>.</h6>






<!--Creative Commons License--><a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/"><img alt="Creative Commons License" border="0" src="http://creativecommons.org/images/public/somerights20.png"/></a><br/><p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/2.5/">Creative Commons Attribution-ShareAlike 2.5 License</a>.</p><!--/Creative Commons License--><!-- <rdf:RDF xmlns="http://web.resource.org/cc/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
	<Work rdf:about="">
		<license rdf:resource="http://creativecommons.org/licenses/by-sa/2.5/" />
	<dc:type rdf:resource="http://purl.org/dc/dcmitype/Text" />
	</Work>
	<License rdf:about="http://creativecommons.org/licenses/by-sa/2.5/"><permits rdf:resource="http://web.resource.org/cc/Reproduction"/><permits rdf:resource="http://web.resource.org/cc/Distribution"/><requires rdf:resource="http://web.resource.org/cc/Notice"/><requires rdf:resource="http://web.resource.org/cc/Attribution"/><permits rdf:resource="http://web.resource.org/cc/DerivativeWorks"/><requires rdf:resource="http://web.resource.org/cc/ShareAlike"/></License></rdf:RDF> -->

<h5><a href="http://flurdy.com"><img
	src="/images/flurdy-small.png" alt="flurdy"
	title="Made by flurdy" border="0" align="right" /></a>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-281408-1";
urchinTracker();
</script>
</body>
<!-- iea 2k8 -->
</html>
